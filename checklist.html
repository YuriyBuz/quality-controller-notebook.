<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ß–µ–∫ –õ–∏—Å—Ç | FoodLine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Base Variables for Theming */
        :root {
            --bg-color: #f8fafc;
            --card-bg-color: #ffffff;
            --text-color: #1e293b;
            --text-muted-color: #64748b;
            --item-bg-color: #f1f5f9;
            --item-hover-bg-color: #e2e8f0;
            --border-color: #e2e8f0;
            --priority-border-color: #fecaca;
            --header-icon-hover-bg: #e5e7eb;
        }

        .dark {
            --bg-color: #0f172a;
            --card-bg-color: #1e293b;
            --text-color: #f1f5f9;
            --text-muted-color: #94a3b8;
            --item-bg-color: #334155;
            --item-hover-bg-color: #475569;
            --border-color: #334155;
            --priority-border-color: #991b1b;
            --header-icon-hover-bg: #334155;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 6rem;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        /* General Component Styling */
        .card { background-color: var(--card-bg-color); transition: background-color 0.3s ease; }
        .text-muted { color: var(--text-muted-color); }
        .header-icon:hover { background-color: var(--header-icon-hover-bg); }

        /* Checklist Items */
        .checklist-item {
            background-color: var(--item-bg-color);
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }
        .checklist-item:hover { background-color: var(--item-hover-bg-color); }
        
        .checklist-item.completed {
            background-color: rgba(16, 185, 129, 0.1);
            border-color: #10b981;
        }
        .dark .checklist-item.completed {
            background-color: rgba(16, 185, 129, 0.1);
            border-color: #059669;
        }

        .checklist-item.completed .task-text { 
            text-decoration: line-through; 
            color: var(--text-muted-color);
        }
        
        /* Icons */
        .checkbox-icon {
            width: 1.5rem;
            height: 1.5rem;
            border: 2px solid #cbd5e1;
            border-radius: 0.375rem;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            background: var(--card-bg-color);
            transition: all 0.2s;
        }
        .dark .checkbox-icon { border-color: #64748b; }

        .checklist-item.completed .checkbox-icon {
            background-color: #10b981;
            border-color: #10b981;
        }
        .checklist-item.completed .checkbox-icon::after {
            content: '‚úî';
            color: white;
            font-size: 14px;
            font-weight: bold;
        }

        /* Problem/Info States */
        .checklist-item.has-problem { border-color: #ef4444; background-color: rgba(239, 68, 68, 0.05); }
        .checklist-item.has-info { border-color: #3b82f6; background-color: rgba(59, 130, 246, 0.05); }

        /* Navigation */
        .nav-button {
            background-color: var(--card-bg-color);
            color: var(--text-muted-color);
            border: 1px solid var(--border-color);
            transition: all 0.3s;
        }
        .nav-button:hover { background-color: var(--item-hover-bg-color); }
        .nav-button.active {
            background-color: #059669;
            color: white;
            border-color: #059669;
            box-shadow: 0 4px 6px -1px rgba(5, 150, 105, 0.2);
        }

        /* Inputs */
        input, select, textarea {
            background-color: var(--card-bg-color) !important;
            color: var(--text-color) !important;
            border: 1px solid var(--border-color) !important;
            transition: border-color 0.2s, ring 0.2s;
        }
        input:focus, select:focus, textarea:focus {
            border-color: #10b981 !important;
            outline: none;
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
        }

        /* Modals */
        .modal-overlay { background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(2px); z-index: 1000; }
        .comment-text { font-size: 0.875rem; color: var(--text-muted-color); margin-top: 0.5rem; padding-left: 2.25rem; font-style: italic; }
        .comment-text.alert { color: #ef4444; font-weight: 600; }
        .comment-text.info { color: #3b82f6; font-weight: 600; }

        /* Print Styles */
        @media print {
            body { padding-bottom: 0; background: white; color: black; }
            header, nav, #footerStatus, .modal-overlay, button { display: none !important; }
            .card { border: none; box-shadow: none; padding: 0; }
            .checklist-item { border: 1px solid #ccc; page-break-inside: avoid; }
        }
        
        .spinner { border: 3px solid rgba(0,0,0,0.1); width: 24px; height: 24px; border-radius: 50%; border-left-color: #10b981; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="font-sans antialiased selection:bg-emerald-100 selection:text-emerald-900">

    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-[2000] flex flex-col gap-2"></div>

    <div class="container mx-auto max-w-3xl p-4 sm:p-6 lg:p-8">
        
        <!-- Header -->
        <header class="relative text-center mb-6">
            <div class="absolute top-0 left-0 flex items-center gap-2">
                <a href="index.html" class="p-2 rounded-lg bg-white dark:bg-slate-800 shadow-sm text-muted hover:text-emerald-600 transition-colors flex items-center gap-2 border border-slate-200 dark:border-slate-700" title="–ù–∞ –≥–æ–ª–æ–≤–Ω—É">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
                    <span class="text-xs font-bold hidden sm:inline">–ú–µ–Ω—é</span>
                </a>
                <div id="current-date" class="text-muted text-xs font-mono font-bold hidden xs:block"></div>
            </div>

            <img src="https://foodline-production.com/wp-content/uploads/2021/10/3752781497_3752781497.webp" alt="Logo" class="w-24 h-auto mx-auto mb-4 rounded-lg shadow-sm bg-white p-1" onerror="this.src='https://placehold.co/100x50?text=FoodLine'">
            <h1 class="text-2xl sm:text-3xl font-bold tracking-tight">–ß–µ–∫ –õ–∏—Å—Ç</h1>
            <p class="text-muted text-sm font-medium">–ö–æ–Ω—Ç—Ä–æ–ª—å —è–∫–æ—Å—Ç—ñ —Ç–∞ –±–µ–∑–ø–µ—á–Ω–æ—Å—Ç—ñ –ø—Ä–æ–¥—É–∫—Ü—ñ—ó</p>

            <div class="absolute top-0 right-0 flex space-x-2">
                <button id="themeToggle" class="p-2 rounded-full text-muted header-icon transition-colors focus:outline-none" title="–ó–º—ñ–Ω–∏—Ç–∏ —Ç–µ–º—É">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg>
                </button>
            </div>
        </header>

        <!-- Employee Select Card -->
        <div class="mb-6 card p-4 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700">
            <label class="block text-sm font-bold mb-2 text-muted">–ö–æ–Ω—Ç—Ä–æ–ª–µ—Ä —è–∫–æ—Å—Ç—ñ:</label>
            <select id="employeeSelect" class="block w-full p-3 border rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none transition-all text-sm font-medium">
                <option value="">–û–±–µ—Ä—ñ—Ç—å –∑—ñ —Å–ø–∏—Å–∫—É...</option>
            </select>
            <p id="employeeSelectionHint" class="text-red-500 text-xs mt-2 hidden font-bold flex items-center gap-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                –ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–µ—Ä—ñ—Ç—å —Å–≤–æ—î —ñ–º'—è!
            </p>
        </div>

        <!-- Navigation Tabs -->
        <nav class="grid grid-cols-3 gap-2 mb-6 p-1 bg-slate-100 dark:bg-slate-800 rounded-xl">
            <button data-view="start" class="nav-button active py-2 px-1 rounded-lg font-bold text-xs sm:text-sm text-center">–ü–æ—á–∞—Ç–æ–∫<br><span class="text-[10px] font-normal opacity-75 leading-tight block mt-0.5">–∑–≤—ñ—Ç –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ –¥–æ 10:00</span></button>
            <button data-view="during" class="nav-button py-2 px-1 rounded-lg font-bold text-xs sm:text-sm text-center">–ó–º—ñ–Ω–∞<br><span class="text-[10px] font-normal opacity-75 leading-tight block mt-0.5">–∑–≤—ñ—Ç –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ –¥–æ 20:00</span></button>
            <button data-view="end" class="nav-button py-2 px-1 rounded-lg font-bold text-xs sm:text-sm text-center">–ö—ñ–Ω–µ—Ü—å<br><span class="text-[10px] font-normal opacity-75 leading-tight block mt-0.5">–∑–≤—ñ—Ç –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ –¥–æ 20:00</span></button>
        </nav>

        <main>
            <!-- CHECKLIST SECTIONS -->
            <section id="startShiftSection" class="view-section">
                <div class="card p-4 sm:p-6 rounded-2xl shadow-md border border-slate-200 dark:border-slate-700">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl sm:text-2xl font-bold text-emerald-700 dark:text-emerald-400">–ü–æ—á–∞—Ç–æ–∫ –∑–º—ñ–Ω–∏</h2>
                        <button id="resetStartBtn" class="px-3 py-1.5 bg-orange-500 text-white text-xs sm:text-sm font-bold rounded-lg hover:bg-orange-600 transition-colors shadow-sm">–°–∫–∏–Ω—É—Ç–∏</button>
                    </div>
                    <ul class="space-y-3" id="list-start"></ul>
                </div>
            </section>

            <section id="duringShiftSection" class="view-section hidden">
                <div class="card p-4 sm:p-6 rounded-2xl shadow-md border border-slate-200 dark:border-slate-700">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl sm:text-2xl font-bold text-blue-700 dark:text-blue-400">–ü—Ä–æ—Ç—è–≥–æ–º –∑–º—ñ–Ω–∏</h2>
                        <button id="resetDuringBtn" class="px-3 py-1.5 bg-orange-500 text-white text-xs sm:text-sm font-bold rounded-lg hover:bg-orange-600 transition-colors shadow-sm">–°–∫–∏–Ω—É—Ç–∏</button>
                    </div>
                    <ul class="space-y-3" id="list-during"></ul>
                </div>
            </section>

            <section id="endShiftSection" class="view-section hidden">
                <div class="card p-4 sm:p-6 rounded-2xl shadow-md border border-slate-200 dark:border-slate-700">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl sm:text-2xl font-bold text-sky-700 dark:text-sky-400">–ö—ñ–Ω–µ—Ü—å –∑–º—ñ–Ω–∏</h2>
                        <button id="resetEndBtn" class="px-3 py-1.5 bg-orange-500 text-white text-xs sm:text-sm font-bold rounded-lg hover:bg-orange-600 transition-colors shadow-sm">–°–∫–∏–Ω—É—Ç–∏</button>
                    </div>
                    <ul class="space-y-3" id="list-end"></ul>
                </div>
            </section>
        </main>
    </div>

    <!-- Footer Progress -->
    <div id="footerStatus" class="fixed bottom-0 left-0 right-0 card p-4 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] flex items-center justify-between z-40 border-t border-slate-200 dark:border-slate-700">
        <div class="w-full max-w-3xl mx-auto">
            <div class="flex justify-between text-xs text-muted mb-1 font-bold">
                <span>–ü—Ä–æ–≥—Ä–µ—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è</span>
                <span id="progressText">0/0</span>
            </div>
            <div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2.5 overflow-hidden">
                <div id="progressBar" class="bg-emerald-500 h-full rounded-full transition-all duration-500 shadow-[0_0_10px_rgba(16,185,129,0.5)]" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="commentModal" class="fixed inset-0 hidden items-center justify-center modal-overlay p-4">
        <div class="card p-6 rounded-2xl shadow-2xl w-full max-w-sm transform transition-all scale-100">
            <h3 class="text-lg font-bold mb-3">üí¨ –ö–æ–º–µ–Ω—Ç–∞—Ä</h3>
            <textarea id="commentInput" class="w-full p-3 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500 resize-none bg-slate-50 dark:bg-slate-800" rows="3" placeholder="–í–≤–µ–¥—ñ—Ç—å –∑–∞–º—ñ—Ç–∫—É..."></textarea>
            <div class="flex justify-end gap-2 mt-4">
                <button class="px-4 py-2 bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-200 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors font-medium" onclick="closeModal('commentModal')">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                <button id="saveCommentBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-bold shadow-lg shadow-blue-500/30">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
            </div>
        </div>
    </div>

    <div id="genericConfirmModal" class="fixed inset-0 hidden items-center justify-center modal-overlay p-4 z-[3000]">
        <div class="card p-6 rounded-2xl shadow-2xl w-full max-w-sm">
            <h3 class="text-xl font-bold mb-2 text-center" id="genericConfirmTitle">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è</h3>
            <p id="genericConfirmText" class="text-center mb-6 text-muted"></p>
            <div class="flex justify-center gap-3">
                <button id="genericConfirmCancel" class="px-5 py-2.5 bg-slate-100 dark:bg-slate-700 rounded-xl hover:bg-slate-200 dark:hover:bg-slate-600 font-bold transition-colors">–ù—ñ</button>
                <button id="genericConfirmOk" class="px-5 py-2.5 bg-red-600 hover:bg-red-700 text-white rounded-xl font-bold shadow-lg shadow-red-500/30 transition-colors">–¢–∞–∫</button>
            </div>
        </div>
    </div>

    <div id="confirmationModal" class="fixed inset-0 hidden items-center justify-center modal-overlay z-[2500] p-4">
        <div class="card p-6 rounded-2xl shadow-2xl w-full max-w-md flex flex-col max-h-[85vh]">
            <div class="text-center mb-4">
                <div class="w-12 h-12 bg-emerald-100 dark:bg-emerald-900/30 rounded-full flex items-center justify-center mx-auto mb-2 text-2xl">üì§</div>
                <h3 class="text-xl font-bold">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏</h3>
                <p class="text-sm text-muted">–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –≤–≤–µ–¥–µ–Ω—ñ –¥–∞–Ω—ñ –ø–µ—Ä–µ–¥ –≤—ñ–¥–ø—Ä–∞–≤–∫–æ—é</p>
            </div>
            
            <div class="bg-slate-50 dark:bg-slate-800 p-4 rounded-xl overflow-y-auto mb-4 border border-slate-200 dark:border-slate-700 text-xs sm:text-sm font-mono whitespace-pre-wrap flex-1 shadow-inner" id="confirmationText"></div>
            
            <p id="sendMsg" class="text-center text-sm font-bold mb-3 min-h-[1.25em] text-emerald-600"></p>
            
            <div id="modalActions" class="flex flex-col gap-2">
                <button id="confirmSendBtn" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-emerald-500/30 transition-all active:scale-[0.98] flex items-center justify-center gap-2">
                    <span>‚úÖ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ —Ç–∞ –ù–∞–¥—ñ—Å–ª–∞—Ç–∏</span>
                </button>
                <button onclick="closeModal('confirmationModal')" class="w-full bg-transparent border border-slate-300 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-700 text-muted font-bold py-3.5 rounded-xl transition-colors">
                    –°–∫–∞—Å—É–≤–∞—Ç–∏
                </button>
            </div>
            
            <div id="modalSpinner" class="hidden py-4 flex justify-center">
                <div class="spinner"></div>
            </div>
        </div>
    </div>

    <script>
        // NEW URL Provided by User
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyg9z5S63_kl-Yxgnho4f5zjT_cCBFizOBp6eWDWQODEZLD0su5YhKAggmETVXgbPbF/exec";

        // Checklist items
        const checklistItems = {
            start: [
                { id: 'start-1-1', text: '–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–∏—Å—Ç–æ—Ç—É —Ç–∞ —Å–ø—Ä–∞–≤–Ω—ñ—Å—Ç—å –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è –≤ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ—ó.', type: 'normal' },
                { id: 'start-1-2', text: '–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É —Å–æ—É—Å—ñ–≤ –ø—ñ—Å–ª—è –Ω—ñ—á–Ω–æ–≥–æ –æ—Ö–æ–ª–æ–¥–∂–µ–Ω–Ω—è (t ‚â§ 24¬∞C).', type: 'problem', btn: '‚ö†Ô∏è –í—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è', fields: ['‚Ññ –ö–æ—Ç–ª–∞', '‚Ññ –ó–∞–≤–¥–∞–Ω–Ω—è', '–°–æ—É—Å', '–¢–µ–º–ø ¬∞C'] },
                { id: 'start-1-3', text: '–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —è–∫—ñ—Å—Ç—å –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ—Ö –≤–∞—Ä–æ–∫ (—Ñ—ñ–∑-—Ö—ñ–º —Ç–∞ –æ—Ä–≥–∞–Ω–æ–ª–µ–ø—Ç–∏–∫–∞).', type: 'problem', btn: '‚õî –ù–ï–î–û–ü–£–°–ö', fields: ['‚Ññ –ó–∞–≤–¥–∞–Ω–Ω—è', '–°–æ—É—Å', '–ü—Ä–∏—á–∏–Ω–∞'] },
                { id: 'start-1-4', text: '–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –∂—É—Ä–Ω–∞–ª –∑–∞–º—ñ–Ω–∏ —Ñ—ñ–ª—å—Ç—Ä—ñ–≤ —Ñ—ñ–ª—å—Ç—Ä–∞ –Ω–∞ –í–ö-1.', type: 'normal' },
            ],
            during: [
                { id: 'during-1-1', text: '–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –≥—ñ–≥—ñ—î–Ω—É –ø–µ—Ä—Å–æ–Ω–∞–ª—É (–æ–¥—è–≥, —à–∞–ø–æ—á–∫–∏, –ø—Ä–∏–∫—Ä–∞—Å–∏).', type: 'normal' },
                { id: 'during-1-2', text: '–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ø—ñ–¥–≥–æ—Ç–æ–≤–∫—É —Å–∏—Ä–æ–≤–∏–Ω–∏ –Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ—Å—Ç—å.', type: 'normal' },
                { id: 'during-1-3', text: '–ü—Ä–æ–≤–µ—Å—Ç–∏ –µ–∫—Å–ø—Ä–µ—Å-—Ç–µ—Å—Ç –ø–æ–∫–∞–∑–Ω–∏–∫—ñ–≤ –≤–æ–¥–æ–ø—ñ–¥–≥–æ—Ç–æ–≤–∫–∏ (–•–í–û).', type: 'problem', btn: '‚ö†Ô∏è –í—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è', fields: ['–ü–æ–∫–∞–∑–Ω–∏–∫', '–ó–Ω–∞—á–µ–Ω–Ω—è'] },
                { id: 'during-1-4', text: '–ü—Ä–æ–≤–µ—Å—Ç–∏ –ø–æ—Ç–æ—á–Ω–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å –±–µ–∑–ø–µ—á–Ω–æ—Å—Ç—ñ –ø—Ä–æ—Ü–µ—Å—É.', type: 'problem', btn: '‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞', fields: ['–û–ø–∏—Å –ø–æ—Ä—É—à–µ–Ω–Ω—è'] },
                { id: 'during-1-5', text: '–í–∏–∫–æ–Ω–∞—Ç–∏ –¥–æ–¥–∞—Ç–∫–æ–≤—ñ –∑–∞–≤–¥–∞–Ω–Ω—è –∫–µ—Ä—ñ–≤–Ω–∏–∫–∞.', type: 'normal' },
                { id: 'during-1-6', text: '–í–∏–¥–∞—Ç–∏ –∫–æ–Ω—Å–µ—Ä–≤–∞–Ω—Ç–∏ –≤–∞—Ä–Ω–∏–∫–∞–º –ø—ñ–¥ –ø—ñ–¥–ø–∏—Å.', type: 'info', btn: 'üìù –ó–∞–ø–∏—Å–∞—Ç–∏', fields: ['–í–∞—Ä–Ω–∏–∫ (–ü–Ü–ë)', '–ö–æ–Ω—Å–µ—Ä–≤–∞–Ω—Ç', '–ö—ñ–ª—å–∫—ñ—Å—Ç—å'] },
            ],
            end: [
                { id: 'end-1-1', text: '–ü—Ä–æ–≤–µ—Å—Ç–∏ –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ –∑–∞–º—ñ—Ä–∏ –¥–ª—è –í–°–Ü–• –≤–∞—Ä–æ–∫ –ø–µ—Ä–µ–¥ –ø–æ—Å—Ç–∞–Ω–æ–≤–∫–æ—é –Ω–∞ –æ—Ö–æ–ª–æ–¥–∂–µ–Ω–Ω—è.', type: 'normal' },
                { id: 'end-1-2', text: '–ü–æ–≤–µ—Ä–Ω—É—Ç–∏ –∑–∞–ª–∏—à–∫–∏ –∫–æ–Ω—Å–µ—Ä–≤–∞–Ω—Ç—ñ–≤ —Ç–∞ —ñ–Ω—à–∏—Ö –¢–ú–¶ –≤ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ—é.', type: 'normal' },
                { id: 'end-1-3', text: '–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Å–∞–Ω—ñ—Ç–∞—Ä–Ω–∏–π —Å—Ç–∞–Ω —Ü–µ—Ö—É.', type: 'problem', btn: '‚ö†Ô∏è –ù–µ–∑–∞–¥–æ–≤—ñ–ª—å–Ω–æ', fields: ['–û–ø–∏—Å –ø—Ä–æ–±–ª–µ–º–∏/–¥—ñ–ª—å–Ω–∏—Ü—è'] },
                { id: 'end-1-4', text: '–ó–∞–ø–æ–≤–Ω–∏—Ç–∏ –∑–≤—ñ—Ç –ø—Ä–æ –Ω–µ–¥–æ–ª—ñ–∫–∏ —Ç–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ –∑–º—ñ–Ω–∏.', type: 'normal' },
                { id: 'end-1-5', text: '–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Ü—ñ–ª—ñ—Å–Ω—ñ—Å—Ç—å —Å–∫–ª–∞ —Ç–∞ –ø–ª–∞—Å—Ç–∏–∫—É (–≤—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å –±–æ—é).', type: 'normal' },
            ]
        };

        const employees = ["–°–æ–±–æ—Ç–æ–≤–∏—á –õ.–ú.", "–û–≥–∞—Ä–∫–æ–≤–∞ –ú.–í."];
        let currentChecklistTab = 'start';
        let activeCommentId = null;
        let pendingReportData = null;
        let confirmCallback = null;

        document.addEventListener('DOMContentLoaded', () => {
            initApp();
        });

        // --- CUSTOM TOAST & CONFIRM ---
        function showToast(message, isError = false) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast bg-white dark:bg-slate-700 border-l-4 p-4 rounded-lg shadow-xl flex items-center max-w-sm transform transition-all duration-300 translate-x-full border border-slate-200 dark:border-slate-600`;
            if (isError) {
                toast.classList.add('border-red-500', 'text-red-700', 'dark:text-red-400');
                toast.innerHTML = `<span class="mr-2 text-xl">üö´</span> <span class="font-medium text-sm">${message}</span>`;
            } else {
                toast.classList.add('border-emerald-500', 'text-emerald-700', 'dark:text-emerald-400');
                toast.innerHTML = `<span class="mr-2 text-xl">‚úÖ</span> <span class="font-medium text-sm">${message}</span>`;
            }
            container.appendChild(toast);
            requestAnimationFrame(() => toast.classList.remove('translate-x-full'));
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function customConfirm(text, onConfirm) {
            document.getElementById('genericConfirmText').innerText = text;
            const modal = document.getElementById('genericConfirmModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            confirmCallback = onConfirm;
        }

        document.getElementById('genericConfirmCancel').addEventListener('click', () => {
            const modal = document.getElementById('genericConfirmModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            confirmCallback = null;
        });

        document.getElementById('genericConfirmOk').addEventListener('click', () => {
            if(confirmCallback) confirmCallback();
            const modal = document.getElementById('genericConfirmModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            confirmCallback = null;
        });

        document.getElementById('themeToggle').addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
        });

        function initApp() {
            if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            }

            const sel = document.getElementById('employeeSelect');
            employees.forEach(e => sel.add(new Option(e, e)));

            const now = new Date();
            const options = { weekday: 'short', day: '2-digit', month: '2-digit', year: 'numeric' };
            const dateStr = new Intl.DateTimeFormat('uk-UA', options).format(now);
            document.getElementById('current-date').innerText = dateStr.charAt(0).toUpperCase() + dateStr.slice(1);
            
            renderChecklist('start');
            renderChecklist('during');
            renderChecklist('end');

            loadState();
            
            document.body.addEventListener('click', handleClick);
            document.body.addEventListener('change', handleInput);
        }

        function renderChecklist(section) {
            const ul = document.getElementById(`list-${section}`);
            ul.innerHTML = checklistItems[section].map(item => {
                let actionBtn = `<button class="action-btn ml-2 p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors text-muted" data-id="${item.id}" data-type="comment" title="–ö–æ–º–µ–Ω—Ç–∞—Ä"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path></svg></button>`;
                let formHtml = '';

                if (item.type !== 'normal') {
                    const btnClass = item.type === 'info' ? 'bg-blue-100 text-blue-700 dark:bg-blue-900/40 dark:text-blue-300' : 'bg-red-100 text-red-700 dark:bg-red-900/40 dark:text-red-300';
                    actionBtn = `<button class="action-btn ml-2 px-3 py-1 rounded-lg text-xs font-bold flex items-center gap-1 ${btnClass} transition-colors hover:opacity-80" data-id="${item.id}" data-type="form">${item.btn}</button>`;
                    // Added data-label attribute here for easier scraping
                    const inputs = item.fields.map((f, i) => `<input type="text" data-field="${i}" data-label="${f}" class="w-full p-2 border rounded-lg text-sm mb-2" placeholder="${f}">`).join('');
                    formHtml = `<div id="form-${item.id}" class="hidden mt-3 p-4 border rounded-xl bg-white dark:bg-slate-800 dark:border-slate-700 shadow-inner"><div class="text-xs font-bold mb-2 text-muted uppercase">${item.btn}</div>${inputs}<div class="flex justify-end gap-2 mt-2"><button class="form-cancel px-3 py-1.5 bg-transparent border border-slate-300 dark:border-slate-600 rounded-lg text-xs font-bold text-muted hover:bg-slate-100 dark:hover:bg-slate-700" data-id="${item.id}">–°–∫–∞—Å—É–≤–∞—Ç–∏</button><button class="form-save px-3 py-1.5 bg-blue-600 text-white rounded-lg text-xs font-bold hover:bg-blue-700" data-id="${item.id}">–ó–±–µ—Ä–µ–≥—Ç–∏</button></div></div>`;
                }
                
                return `
                <li id="${item.id}" class="checklist-item p-3 sm:p-4 rounded-xl flex flex-col cursor-pointer select-none">
                    <div class="flex items-center justify-between w-full">
                        <div class="flex items-center flex-1 check-trigger" data-id="${item.id}">
                            <div class="checkbox-icon mr-3 sm:mr-4"></div>
                            <span class="task-text text-sm sm:text-base font-medium">${item.text}</span>
                        </div>
                        ${actionBtn}
                    </div>
                    ${formHtml}
                    <div class="comment-text hidden"></div>
                </li>`;
            }).join('');
            
            const sendBtnHtml = `
            <button onclick="prepareChecklistReport('${section}')" class="w-full mt-6 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-4 rounded-xl shadow-lg transition-all active:scale-[0.98] flex items-center justify-center gap-2 text-lg">
                <span>üì§ –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –∑–≤—ñ—Ç (${section === 'start' ? '–ü–æ—á–∞—Ç–æ–∫' : (section === 'during' ? '–ó–º—ñ–Ω–∞' : '–ö—ñ–Ω–µ—Ü—å')})</span>
            </button>`;
            
            const btnContainer = document.createElement('div');
            btnContainer.innerHTML = sendBtnHtml;
            ul.parentNode.appendChild(btnContainer);
        }

        function handleClick(e) {
            if (e.target.closest('.nav-button')) {
                const view = e.target.closest('.nav-button').dataset.view;
                switchView(view);
            }
            if (e.target.id === 'resetStartBtn') resetSection('startShiftSection');
            if (e.target.id === 'resetDuringBtn') resetSection('duringShiftSection');
            if (e.target.id === 'resetEndBtn') resetSection('endShiftSection');

            if (e.target.closest('.check-trigger')) {
                if (!validateEmployee()) return;
                const id = e.target.closest('.check-trigger').dataset.id;
                toggleItem(id);
            }

            if (e.target.closest('.action-btn')) {
                e.stopPropagation();
                if (!validateEmployee()) return;
                const btn = e.target.closest('.action-btn');
                const id = btn.dataset.id;
                if (btn.dataset.type === 'form') {
                    document.getElementById(`form-${id}`).classList.toggle('hidden');
                } else {
                    activeCommentId = id;
                    document.getElementById('commentInput').value = document.querySelector(`#${id} .comment-text`).innerText;
                    const modal = document.getElementById('commentModal');
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                }
            }

            if (e.target.classList.contains('form-cancel')) document.getElementById(`form-${e.target.dataset.id}`).classList.add('hidden');
            if (e.target.classList.contains('form-save')) saveForm(e.target.dataset.id);
            if (e.target.id === 'saveCommentBtn') saveComment();
            if (e.target.id === 'confirmSendBtn') executeSend();
        }

        function handleInput(e) {
            if (['INPUT', 'SELECT', 'TEXTAREA'].includes(e.target.tagName)) {
                saveState();
            }
        }

        function validateEmployee() {
            const select = document.getElementById('employeeSelect');
            if (!select.value) {
                showToast("–û–±–µ—Ä—ñ—Ç—å —ñ–º'—è –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∞!", true);
                document.getElementById('employeeSelectionHint').classList.remove('hidden');
                select.focus();
                return false;
            }
            document.getElementById('employeeSelectionHint').classList.add('hidden');
            return true;
        }

        function toggleItem(id) {
            const el = document.getElementById(id);
            el.classList.toggle('completed');
            if (el.classList.contains('completed')) {
                el.classList.remove('has-problem', 'has-info');
                const c = el.querySelector('.comment-text');
                c.innerText = ''; c.classList.add('hidden', 'alert', 'info');
                const f = document.getElementById(`form-${id}`);
                if(f) f.classList.add('hidden');
            }
            saveState();
            updateProgress();
        }

        function saveForm(id) {
            const form = document.getElementById(`form-${id}`);
            const inputs = form.querySelectorAll('input');
            const values = [];
            let isValid = true;

            inputs.forEach(input => {
                if (!input.value) isValid = false;
                // Capture field label (e.g., "Temperature") along with value
                values.push(`[${input.dataset.label}: ${input.value}]`);
            });

            if (!isValid) { showToast("–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–æ–ª—è!", true); return; }
            
            const item = document.getElementById(id);
            const isInfo = item.innerHTML.includes('text-blue-700'); 
            const c = item.querySelector('.comment-text');
            
            // Join with spaces for readability
            c.innerText = values.join(' '); 
            
            c.classList.remove('hidden', 'alert', 'info');
            c.classList.add(isInfo ? 'info' : 'alert');
            
            item.classList.remove('has-problem', 'has-info');
            item.classList.add(isInfo ? 'has-info' : 'has-problem');
            item.classList.add('completed');
            
            form.classList.add('hidden');
            saveState();
            updateProgress();
        }

        function saveComment() {
            const txt = document.getElementById('commentInput').value;
            const item = document.getElementById(activeCommentId);
            const c = item.querySelector('.comment-text');
            c.innerText = txt;
            if(txt) { 
                c.classList.remove('hidden'); 
                item.classList.add('has-info'); 
            } else { 
                c.classList.add('hidden'); 
                item.classList.remove('has-info'); 
            }
            closeModal('commentModal');
            saveState();
        }

        function updateProgress() {
            const list = document.getElementById(`list-${currentChecklistTab}`);
            const listItems = list.querySelectorAll('.checklist-item');
            const totalItems = listItems.length;
            const done = list.querySelectorAll('.completed').length;
            const percent = totalItems > 0 ? (done/totalItems)*100 : 0;
            
            document.getElementById('progressBar').style.width = `${percent}%`;
            document.getElementById('progressText').innerText = `${done}/${totalItems} –∑–∞–≤–¥–∞–Ω—å`;
        }

        function switchView(view) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-button').forEach(b => b.classList.remove('active'));
            document.getElementById(`${view}ShiftSection`).classList.remove('hidden');
            document.querySelector(`[data-view="${view}"]`).classList.add('active');
            currentChecklistTab = view;
            updateProgress();
        }

        function resetSection(sectionId) {
            customConfirm('–í–∏ –¥—ñ–π—Å–Ω–æ –±–∞–∂–∞—î—Ç–µ –æ—á–∏—Å—Ç–∏—Ç–∏ –≤—Å—ñ –ø–æ–ª—è –≤ —Ü—å–æ–º—É —Ä–æ–∑–¥—ñ–ª—ñ?', () => {
                const section = document.getElementById(sectionId);
                section.querySelectorAll('.checklist-item').forEach(el => {
                    el.classList.remove('completed', 'has-problem', 'has-info');
                    const c = el.querySelector('.comment-text');
                    if(c) { c.innerText = ''; c.classList.add('hidden', 'alert', 'info'); }
                    el.querySelectorAll('input').forEach(i => i.value = '');
                    const f = el.querySelector('[id^="form-"]');
                    if(f) f.classList.add('hidden');
                });
                saveState();
                updateProgress();
                showToast("–†–æ–∑–¥—ñ–ª —É—Å–ø—ñ—à–Ω–æ –æ—á–∏—â–µ–Ω–æ");
            });
        }

        function prepareChecklistReport(key) {
            if (!validateEmployee()) return;

            let report = "";
            let problemCount = 0;
            const listItems = document.getElementById(`list-${key}`).querySelectorAll('.checklist-item');
            const totalItems = listItems.length;
            const doneItems = document.getElementById(`list-${key}`).querySelectorAll('.checklist-item.completed').length;
            
            listItems.forEach(item => {
                const text = item.querySelector('.task-text').innerText;
                const status = item.classList.contains('completed') ? (item.classList.contains('has-problem') ? "‚ö†Ô∏è" : "‚úÖ") : "‚ùå";
                
                // Get innerText of comment-text div. 
                // Note: saveForm now puts formatted text here like "[Temp: 25]", so we just grab it.
                const comment = item.querySelector('.comment-text').innerText;
                
                if (item.classList.contains('has-problem')) problemCount++;
                
                // New Format: ICON | TEXT | COMMENT
                report += `${status} | ${text} ${comment ? ' ‚Äî ' + comment : ''}\n`;
            });

            const titles = { 'start': '–ü–æ—á–∞—Ç–æ–∫ –∑–º—ñ–Ω–∏', 'during': '–ü—Ä–æ—Ç—è–≥–æ–º –∑–º—ñ–Ω–∏', 'end': '–ö—ñ–Ω–µ—Ü—å –∑–º—ñ–Ω–∏' };

            // –û–ù–û–í–õ–ï–ù–ê –°–¢–†–£–ö–¢–£–†–ê –û–ë'–Ñ–ö–¢–ê –ü–Ü–î GOOGLE SCRIPT
            pendingReportData = {
                type: 'checklist',
                employee: document.getElementById('employeeSelect').value,
                stage: titles[key],
                done: doneItems,
                total: totalItems,
                reportText: report
            };
            
            pendingReportData.time = new Date().toLocaleTimeString('uk-UA');
            pendingReportData.section = `–ß–µ–∫-–ª–∏—Å—Ç: ${titles[key]}`;
            pendingReportData.report = report;

            showConfirmation(report);
        }

        function showConfirmation(text) {
            document.getElementById('confirmationText').innerText = text;
            const modal = document.getElementById('confirmationModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            document.getElementById('modalActions').style.display = 'flex';
            document.getElementById('modalSpinner').classList.add('hidden');
            document.getElementById('sendMsg').innerText = "";
        }

        async function executeSend() {
            const btnSpinner = document.getElementById('modalSpinner');
            const actions = document.getElementById('modalActions');
            const msg = document.getElementById('sendMsg');
            
            actions.style.display = 'none';
            btnSpinner.classList.remove('hidden');
            msg.innerText = "–í—ñ–¥–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–∏—Ö...";

            try {
                const url = GOOGLE_SCRIPT_URL + "?t=" + new Date().getTime();
                
                await fetch(url, {
                    method: 'POST',
                    mode: 'no-cors', 
                    cache: 'no-cache',
                    keepalive: true,
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8',
                    },
                    body: JSON.stringify(pendingReportData)
                });
                
                msg.innerText = "‚úÖ –î–∞–Ω—ñ —É—Å–ø—ñ—à–Ω–æ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ!";
                msg.classList.remove('text-red-500');
                msg.classList.add('text-emerald-600');
            } catch (e) {
                console.error("Fetch Error:", e);
                msg.innerText = "‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è (–º–µ—Ä–µ–∂–µ–≤–∞ –ø–æ–º–∏–ª–∫–∞)";
                msg.classList.add('text-red-500');
            }

            const subject = encodeURIComponent(`${pendingReportData.section} - ${pendingReportData.employee}`);
            const body = encodeURIComponent(pendingReportData.report);
            
            setTimeout(() => {
                const mailtoLink = `mailto:Dyndarnastia@gmail.com,Buznitskiy7@gmail.com?subject=${subject}&body=${body}`;
                const link = document.createElement('a');
                link.href = mailtoLink;
                link.click();

                setTimeout(() => closeModal('confirmationModal'), 2000);
            }, 1000);
        }

        function closeModal(id) {
            const el = document.getElementById(id);
            el.classList.add('hidden');
            el.classList.remove('flex');
        }

        function saveState() {
            const state = {
                employee: document.getElementById('employeeSelect').value,
                items: {},
                inputs: {}
            };
            document.querySelectorAll('.checklist-item').forEach(el => {
                state.items[el.id] = {
                    completed: el.classList.contains('completed'),
                    problem: el.classList.contains('has-problem'),
                    info: el.classList.contains('has-info'),
                    comment: el.querySelector('.comment-text').innerText
                };
            });
            document.querySelectorAll('input').forEach(el => {
                if (el.dataset.field !== undefined && el.closest('.checklist-item')) {
                   const parentId = el.closest('.checklist-item').id;
                   if(!state.inputs[parentId]) state.inputs[parentId] = [];
                   state.inputs[parentId][el.dataset.field] = el.value;
                }
            });
            localStorage.setItem('qcState_Simple_v1', JSON.stringify(state));
        }

        function loadState() {
            const raw = localStorage.getItem('qcState_Simple_v1');
            if (!raw) return;
            const state = JSON.parse(raw);
            if (state.employee) {
                document.getElementById('employeeSelect').value = state.employee;
                document.getElementById('employeeSelectionHint').classList.add('hidden');
            }
            if (state.items) {
                Object.keys(state.items).forEach(id => {
                    const el = document.getElementById(id);
                    const s = state.items[id];
                    if (el && s) {
                        if(s.completed) el.classList.add('completed');
                        if(s.problem) { el.classList.add('has-problem'); el.querySelector('.comment-text').classList.add('alert'); }
                        if(s.info) { el.classList.add('has-info'); el.querySelector('.comment-text').classList.add('info'); }
                        if(s.comment) {
                            el.querySelector('.comment-text').innerText = s.comment;
                            el.querySelector('.comment-text').classList.remove('hidden');
                        }
                    }
                });
            }
            if (state.inputs) {
                Object.keys(state.inputs).forEach(parentId => {
                    const vals = state.inputs[parentId];
                    const parent = document.getElementById(parentId);
                    if(parent && vals) {
                         vals.forEach((val, index) => {
                             const input = parent.querySelector(`input[data-field="${index}"]`);
                             if(input) input.value = val;
                         });
                    }
                });
            }
        }
    </script>
</body>
</html>
