function doPost(e) {
  var lock = LockService.getScriptLock();
  lock.tryLock(10000);

  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var rawData;
    
    try {
      rawData = JSON.parse(e.postData.contents);
    } catch (error) {
      return ContentService.createTextOutput(JSON.stringify({ "result": "error", "error": "Invalid JSON" })).setMimeType(ContentService.MimeType.JSON);
    }

    // === 1. –û–¢–†–ò–ú–ê–ù–ù–Ø –î–ê–ù–ò–• (READ) ===
    if (rawData.action === 'getData') {
       var data = handleGetData(ss, rawData);
       return ContentService.createTextOutput(JSON.stringify(data)).setMimeType(ContentService.MimeType.JSON);
    }

    // === 2. –ó–ê–ü–ò–° –î–ê–ù–ò–• (WRITE) ===
    var timestamp = new Date();
    var sheetName = "";
    var rowData = [];

    // –í–∏–∑–Ω–∞—á–∞—î–º–æ –∫—É–¥–∏ –ø–∏—Å–∞—Ç–∏
    if (rawData.type === 'sauce') {
      sheetName = "Sauce";
      rowData = [timestamp, rawData.time, rawData.employee, rawData.cook, rawData.product, rawData.task, rawData.cookDate, rawData.color, rawData.aroma, rawData.taste, rawData.consist, rawData.dry, rawData.visc, rawData.ph, rawData.stability];
    } else if (rawData.type === 'labeling') {
      sheetName = "Labeling";
      rowData = [timestamp, rawData.time, rawData.employee, rawData.machine, rawData.tm, rawData.product, rawData.task, rawData.sanitary, rawData.labelDate, rawData.batch, rawData.width, rawData.temp, rawData.checkLabel, rawData.checkPack, rawData.checkSticker, rawData.checkLayout, rawData.checkPallet, rawData.comment, rawData.photo];
    } else if (rawData.type === 'cleaning') {
      sheetName = "Cleaning";
      rowData = [timestamp, rawData.date, rawData.time, rawData.employee, rawData.equipType, rawData.equipObj, rawData.ext, rawData.int, rawData.agg, rawData.resp, rawData.signature];
    } else if (rawData.type === 'checklist') {
      sheetName = "Checklist";
      rowData = [timestamp, rawData.employee, rawData.stage, rawData.done, rawData.total, rawData.reportText];
    } else if (rawData.type === 'packing') {
      sheetName = "Packing";
      rowData = [timestamp, rawData.time, rawData.employee, rawData.line, rawData.productCode, rawData.tm, rawData.sku, rawData.batch, rawData.weight, rawData.seal, rawData.print, rawData.appearance, rawData.cap, rawData.comment];
    } else if (rawData.type === 'hvo_control') {
      sheetName = "HVO";
      rowData = [timestamp, rawData.timeVal, rawData.employee, rawData.systemStatus, rawData.salt1, rawData.salt2, rawData.rotSoft, rawData.rotPure, rawData.hardness, rawData.iron, rawData.manganese, rawData.ph, rawData.report];
    }

    // –ó–∞–ø–∏—Å –≤ —Ç–∞–±–ª–∏—Ü—é
    if (sheetName) {
      var sheet = getOrCreateSheet(ss, sheetName);
      var cleanRow = rowData.map(function(item) { return sanitize(item); });
      sheet.appendRow(cleanRow);
    }

    // === 3. –í–Ü–î–ü–†–ê–í–ö–ê EMAIL (SERVER-SIDE) ===
    // –°–ø–∏—Å–æ–∫ –æ—Ç—Ä–∏–º—É–≤–∞—á—ñ–≤ —á–µ—Ä–µ–∑ –∫–æ–º—É
    var emailRecipients = "Buznitskiy7@gmail.com";
    
    var subject = "–ó–≤—ñ—Ç QC: " + (rawData.section || rawData.type || sheetName);
    var body = rawData.report || ("–ù–æ–≤–∏–π –∑–∞–ø–∏—Å —É —Ç–∞–±–ª–∏—Ü—ñ " + sheetName + ".\n–ß–∞—Å: " + timestamp);
    
    var emailOptions = {
      name: "QC Master Bot"
    };

    // –û–±—Ä–æ–±–∫–∞ –≤–∫–ª–∞–¥–µ–Ω–Ω—è (—Ñ–æ—Ç–æ), —è–∫—â–æ —î (Base64)
    if (rawData.photo && rawData.photo.indexOf('base64') > -1) {
      var blobs = [];
      try {
        var base64Data = rawData.photo.split(',')[1];
        var decoded = Utilities.base64Decode(base64Data);
        var blob = Utilities.newBlob(decoded, 'image/jpeg', 'photo_report.jpg');
        blobs.push(blob);
        emailOptions.attachments = blobs;
      } catch (e) {
        body += "\n\n[–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏–∫—Ä—ñ–ø–ª–µ–Ω–Ω—è —Ñ–æ—Ç–æ: " + e.toString() + "]";
      }
    }

    try {
        // –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –ª–∏—Å—Ç–∞
        MailApp.sendEmail(emailRecipients, subject, body, emailOptions);
    } catch (emailError) {
        console.error("Email send failed: " + emailError.toString());
        // –ü—Ä–æ–¥–æ–≤–∂—É—î–º–æ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è, –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ –ª–∏—Å—Ç –Ω–µ –ø—ñ—à–æ–≤, —â–æ–± –ø–æ–≤–µ—Ä–Ω—É—Ç–∏ —É—Å–ø—ñ—Ö –∫–ª—ñ—î–Ω—Ç—É
    }

    return ContentService.createTextOutput(JSON.stringify({ "result": "success" })).setMimeType(ContentService.MimeType.JSON);

  } catch (e) {
    return ContentService.createTextOutput(JSON.stringify({ "result": "error", "error": e.toString() })).setMimeType(ContentService.MimeType.JSON);
  } finally {
    lock.releaseLock();
  }
}

// === –§–£–ù–ö–¶–Ü–Ø –û–¢–†–ò–ú–ê–ù–ù–Ø –î–ê–ù–ò–• (READ) ===
function handleGetData(ss, filters) {
  var results = [];
  var limit = 50; 
  
  var sheetsConfig = {
    'checklist': {
      name: 'Checklist', colDate: 0, colEmp: 1,  
      mapRow: function(row) { return { time: formatDate(row[0]), employee: row[1], section: 'checklist', status: (row[3] == row[4]) ? 'OK' : 'Incomplete', summary: row[2] + " (" + row[3] + "/" + row[4] + ")", report: row[5] }; }
    },
    'sauce_boiling': {
      name: 'Sauce', colDate: 0, colEmp: 2,
      mapRow: function(row) { return { time: formatDate(row[0]), employee: row[2], section: 'sauce_boiling', status: 'OK', summary: row[4] + " (" + row[3] + ")", report: createReportText('–í–∞—Ä–∫–∏ —Å–æ—É—Å—É', row, ['–ß–∞—Å:1','–í–∞—Ä–Ω–∏–∫:3','–ü—Ä–æ–¥—É–∫—Ç:4','–ó–∞–≤–¥–∞–Ω–Ω—è:5','–î–∞—Ç–∞ –≤–∞—Ä–∫–∏:6','–ö–æ–ª—ñ—Ä:7','–ê—Ä–æ–º–∞—Ç:8','–°–º–∞–∫:9','–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ü—ñ—è:10','–°—É—Ö—ñ:11','–í—è–∑–∫—ñ—Å—Ç—å:12','pH:13','–°—Ç—ñ–π–∫—ñ—Å—Ç—å:14']) }; }
    },
    'labeling': {
      name: 'Labeling', colDate: 0, colEmp: 2,
      mapRow: function(row) {
        var status = (String(row).indexOf('‚ùå') !== -1 || String(row).indexOf('FAIL') !== -1) ? 'FAIL' : 'OK';
        // row[18] - —Ü–µ –∫–æ–ª–æ–Ω–∫–∞ –∑ —Ñ–æ—Ç–æ (Base64), —è–∫—â–æ –≤–æ–Ω–∞ —ñ—Å–Ω—É—î –≤ —Ç–∞–±–ª–∏—Ü—ñ
        return { time: formatDate(row[0]), employee: row[2], section: 'labeling', status: status, summary: row[5] + " (" + row[3] + ")", report: createReportText('–ï—Ç–∏–∫–µ—Ç—É–≤–∞–Ω–Ω—è', row, ['–ß–∞—Å:1','–ú–∞—à–∏–Ω–∞:3','–¢–ú:4','–ü—Ä–æ–¥—É–∫—Ç:5','–ó–∞–≤–¥–∞–Ω–Ω—è:6','–°–∞–Ω—ñ—Ç–∞—Ä—ñ—è:7','–î–∞—Ç–∞ –µ—Ç–∏–∫–µ—Ç–∫–∏:8','–ü–∞—Ä—Ç—ñ—è:9','–ü–ª—ñ–≤–∫–∞:10','–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞:11','–ï—Ç–∏–∫–µ—Ç–∫–∞:12','–ü–∞–∫:13','–°—Ç—ñ–∫–µ—Ä:14','–†–æ–∑–∫–ª–∞–¥–∫–∞:15','–ü–∞–ª–µ—Ç—É–≤–∞–Ω–Ω—è:16','–ö–æ–º–µ–Ω—Ç–∞—Ä:17']), photo: row[18] };
      }
    },
    'packing': {
      name: 'Packing', colDate: 0, colEmp: 2,
      mapRow: function(row) {
        var status = String(row).indexOf('FAIL') !== -1 ? 'FAIL' : 'OK';
        return { time: formatDate(row[0]), employee: row[2], section: 'packing', status: status, summary: row[6] + " (" + row[3] + ")", report: createReportText('–§–∞—Å—É–≤–∞–Ω–Ω—è', row, ['–ß–∞—Å:1','–õ—ñ–Ω—ñ—è:3','–ö–æ–¥:4','–¢–ú:5','SKU:6','–ü–∞—Ä—Ç—ñ—è:7','–í–∞–≥–∞:8','–ì–µ—Ä–º–µ—Ç–∏—á–Ω—ñ—Å—Ç—å:9','–ú–∞—Ä–∫—É–≤–∞–Ω–Ω—è:10','–í–∏–≥–ª—è–¥:11','–ö—Ä–∏—à–∫–∞:12','–ö–æ–º–µ–Ω—Ç–∞—Ä:13']) }; 
      }
    },
    'cleaning': {
      name: 'Cleaning', colDate: 0, colEmp: 3,
      mapRow: function(row) {
        return { time: formatDate(row[0]), employee: row[3], section: 'cleaning', status: 'OK', summary: row[4] + " - " + row[5], report: createReportText('–ú–∏–π–∫–∏', row, ['–î–∞—Ç–∞:1','–ß–∞—Å:2','–¢–∏–ø:4','–û–±—î–∫—Ç:5','–ó–æ–≤–Ω—ñ—à–Ω—î:6','–í–Ω—É—Ç—Ä—ñ—à–Ω—î:7','–ê–≥—Ä–µ–≥–∞—Ç–∏:8','–í—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω–∏–π:9']) };
      }
    },
    'hvo_control': {
      name: 'HVO', colDate: 0, colEmp: 2,
      mapRow: function(row) {
        return { time: formatDate(row[0]), employee: row[2], section: 'hvo_control', status: String(row[3]).indexOf('–ù–µ') !== -1 ? 'FAIL' : 'OK', summary: "–°—Ç–∞—Ç—É—Å: " + row[3], report: row[12] };
      }
    }
  };

  var start = new Date(filters.dateStart); start.setHours(0,0,0,0);
  var end = new Date(filters.dateEnd); end.setHours(23,59,59,999);
  var empFilter = filters.employee;
  var sectionFilter = filters.section;

  var sectionsToScan = (sectionFilter === 'all') ? Object.keys(sheetsConfig) : [sectionFilter];

  sectionsToScan.forEach(function(key) {
    if (results.length >= limit || !sheetsConfig[key]) return;
    var config = sheetsConfig[key];
    var sheet = ss.getSheetByName(config.name);
    if (!sheet) return;

    var lastRow = sheet.getLastRow();
    if (lastRow < 2) return; 

    var startRow = Math.max(2, lastRow - 50); 
    var data = sheet.getRange(startRow, 1, lastRow - startRow + 1, sheet.getLastColumn()).getValues();

    for (var i = data.length - 1; i >= 0; i--) {
      var row = data[i];
      var rowDate = new Date(row[config.colDate]);
      var rowEmp = row[config.colEmp];

      if (rowDate >= start && rowDate <= end) {
        if (empFilter === 'all' || rowEmp === empFilter) {
          results.push(config.mapRow(row));
          if (results.length >= limit) break;
        }
      }
    }
  });

  results.sort(function(a, b) { return new Date(b.time) - new Date(a.time); });
  return results;
}

// Helper to reconstruct report text if not stored directly
function createReportText(title, row, mapping) {
  var text = "üìù –ó–í–Ü–¢ QC: " + title + "\n===========================\n";
  mapping.forEach(function(map) {
    var parts = map.split(':');
    var label = parts[0];
    var idx = parseInt(parts[1]);
    var val = row[idx];
    if(val) text += label + ": " + val + "\n";
  });
  return text;
}

function sanitize(value) {
  if (value === undefined || value === null) return "";
  var str = String(value);
  if (str.charAt(0) === '=' || str.charAt(0) === '+' || str.charAt(0) === '-' || str.charAt(0) === '@') return "'" + str;
  return str;
}

function getOrCreateSheet(ss, name) {
  var sheet = ss.getSheetByName(name);
  if (!sheet) sheet = ss.insertSheet(name);
  return sheet;
}

function formatDate(dateObj) {
  if (!dateObj) return "";
  try {
    var d = new Date(dateObj);
    return d.toLocaleDateString('uk-UA') + " " + d.toLocaleTimeString('uk-UA');
  } catch(e) { return String(dateObj); }
}
