<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–Ü–º–ø–æ—Ä—Ç –¥–∞–Ω–∏—Ö | QC Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: { colors: { slate: { 50: '#f8fafc', 800: '#1e293b', 900: '#0f172a' } } }
            }
        }
    </script>
    <style>
        :root { --bg-color: #f8fafc; --card-bg: #fff; --text: #1e293b; }
        .dark { --bg-color: #0f172a; --card-bg: #1e293b; --text: #f1f5f9; }
        body { background-color: var(--bg-color); color: var(--text); padding-bottom: 2rem; transition: background-color 0.3s ease; }
        .card { background-color: var(--card-bg); transition: background-color 0.3s ease; }
        
        input, select {
            background-color: transparent !important;
            border: 2px solid #cbd5e1 !important;
            padding: 1.3rem 1rem !important; /* Increased padding */
            border-radius: 0.5rem !important;
            width: 100%;
            font-size: 1.125rem !important; /* Increased font size */
            color: inherit;
            transition: border-color 0.2s;
            appearance: none;
        }
        .dark input, .dark select { border-color: #475569 !important; }
        
        /* Focus ring color for Fuchsia theme */
        input:focus, select:focus { outline: none; border-color: #c026d3 !important; box-shadow: 0 0 0 2px rgba(192, 38, 211, 0.2); }
        
        .spinner { border: 3px solid rgba(0,0,0,0.1); width: 24px; height: 24px; border-radius: 50%; border-left-color: #c026d3; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        .modal-overlay { background-color: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 50; }

        @media print {
            body * { visibility: hidden; }
            #resultsArea, #resultsArea * { visibility: visible; }
            #resultsArea { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="font-sans antialiased">

    <div id="toast-container" class="fixed top-4 right-4 z-[2000] flex flex-col gap-2"></div>

    <div class="container mx-auto max-w-5xl p-4 sm:p-6 lg:p-8">
        <header class="flex items-center gap-4 mb-8 no-print">
            <a href="index.html" class="p-3 bg-white dark:bg-slate-800 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 text-slate-500 hover:text-fuchsia-600 transition-colors flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" /></svg>
                <span class="font-bold hidden sm:inline">–ú–µ–Ω—é</span>
            </a>
            
            <div class="flex-1 text-center">
                <h1 class="text-3xl font-bold text-fuchsia-700 dark:text-fuchsia-500">–Ü–º–ø–æ—Ä—Ç –¥–∞–Ω–∏—Ö</h1>
                <p class="text-fuchsia-600 dark:text-fuchsia-400 text-sm font-bold mt-1 uppercase tracking-wide">–ê–Ω–∞–ª—ñ—Ç–∏–∫–∞ —Ç–∞ –ó–≤—ñ—Ç–∏</p>
            </div>
            
            <!-- Download Icon -->
            <div class="p-2 text-fuchsia-500">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
            </div>

            <button id="themeToggle" class="p-3 rounded-lg text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
            </button>
        </header>

        <!-- Filters Section -->
        <div class="card p-8 rounded-lg shadow-lg border border-slate-200 dark:border-slate-700 mb-8 no-print">
            <h3 class="text-sm font-bold text-fuchsia-800 dark:text-fuchsia-400 uppercase mb-6 border-b border-fuchsia-200 dark:border-slate-600 pb-2">–ü–∞—Ä–∞–º–µ—Ç—Ä–∏ –ø–æ—à—É–∫—É</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div>
                    <label class="block text-sm font-bold text-slate-500 dark:text-slate-400 uppercase mb-2">–î–∞—Ç–∞ –∑</label>
                    <input type="date" id="filter-date-start">
                </div>
                <div>
                    <label class="block text-sm font-bold text-slate-500 dark:text-slate-400 uppercase mb-2">–î–∞—Ç–∞ –ø–æ</label>
                    <input type="date" id="filter-date-end">
                </div>
                <div>
                    <label class="block text-sm font-bold text-slate-500 dark:text-slate-400 uppercase mb-2">–ö–æ–Ω—Ç—Ä–æ–ª–µ—Ä</label>
                    <select id="filter-employee">
                        <option value="all">–í—Å—ñ –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∏</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-bold text-slate-500 dark:text-slate-400 uppercase mb-2">–†–æ–∑–¥—ñ–ª</label>
                    <select id="filter-section">
                        <option value="all">–í—Å—ñ —Ä–æ–∑–¥—ñ–ª–∏</option>
                        <option value="checklist">–ß–µ–∫-–ª–∏—Å—Ç</option>
                        <option value="sauce_boiling">–í–∞—Ä–∫–∏ —Å–æ—É—Å—É</option>
                        <option value="labeling">–ï—Ç–∏–∫–µ—Ç—É–≤–∞–Ω–Ω—è</option>
                        <option value="packing">–§–∞—Å—É–≤–∞–Ω–Ω—è</option>
                        <option value="cleaning">–ú–∏–π–∫–∏</option>
                        <option value="hvo_control">–õ–∞–±. –ö–æ–Ω—Ç—Ä–æ–ª—å –•–í–û</option>
                    </select>
                </div>
            </div>

            <div class="mt-8 flex justify-end">
                <button onclick="fetchData()" class="bg-fuchsia-600 hover:bg-fuchsia-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition-all active:scale-95 flex items-center gap-2 text-lg">
                    <span id="btn-text">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑–≤—ñ—Ç</span>
                    <div id="btn-spinner" class="spinner hidden border-white border-l-transparent w-5 h-5"></div>
                </button>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsArea" class="hidden space-y-4">
            <div class="flex justify-between items-center mb-2 no-print">
                <h2 class="text-2xl font-bold text-slate-700 dark:text-slate-200">–†–µ–∑—É–ª—å—Ç–∞—Ç–∏</h2>
                <button onclick="window.print()" class="text-slate-500 hover:text-slate-700 dark:hover:text-slate-300 flex items-center gap-1 font-bold transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                    –î—Ä—É–∫
                </button>
            </div>

            <div class="card rounded-lg shadow-lg border border-slate-200 dark:border-slate-700 overflow-hidden">
                <!-- Clean Header for Table -->
                <div class="bg-slate-100 dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 p-4 flex justify-between items-center">
                    <span class="font-bold text-slate-600 dark:text-slate-300 uppercase text-sm">–ó–Ω–∞–π–¥–µ–Ω–æ –∑–∞–ø–∏—Å—ñ–≤: <span id="recordCount" class="text-fuchsia-600 dark:text-fuchsia-400">0</span></span>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs uppercase bg-slate-50 dark:bg-slate-900/50 text-slate-500 dark:text-slate-400">
                            <tr>
                                <th class="px-6 py-4">–î–∞—Ç–∞/–ß–∞—Å</th>
                                <th class="px-6 py-4">–ö–æ–Ω—Ç—Ä–æ–ª–µ—Ä</th>
                                <th class="px-6 py-4">–†–æ–∑–¥—ñ–ª</th>
                                <th class="px-6 py-4">–ö–æ—Ä–æ—Ç–∫–∏–π –∑–º—ñ—Å—Ç / –°—Ç–∞—Ç—É—Å</th>
                                <th class="px-6 py-4 text-center no-print">–î—ñ—ó</th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody" class="divide-y divide-slate-200 dark:divide-slate-700">
                            <!-- Rows will be injected here -->
                        </tbody>
                    </table>
                </div>
                <div id="emptyState" class="hidden p-12 text-center text-slate-500 dark:text-slate-400 flex flex-col items-center">
                    <svg class="w-12 h-12 mb-3 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <span>–î–∞–Ω–∏—Ö –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∑–∞ –≤–∫–∞–∑–∞–Ω–∏–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏.</span>
                </div>
            </div>
        </div>

    </div>

    <!-- Modal for Full Report -->
    <div id="reportModal" class="hidden fixed inset-0 items-center justify-center modal-overlay p-4 z-50">
        <div class="card p-6 rounded-lg shadow-2xl w-full max-w-2xl flex flex-col max-h-[90vh] border border-slate-200 dark:border-slate-700 relative">
            <button onclick="document.getElementById('reportModal').classList.add('hidden'); document.getElementById('reportModal').classList.remove('flex')" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h3 class="text-xl font-bold mb-6 pr-8 text-fuchsia-700 dark:text-fuchsia-400 border-b border-slate-200 dark:border-slate-700 pb-2">–î–µ—Ç–∞–ª—ñ –∑–≤—ñ—Ç—É</h3>
            <!-- Changed to div with whitespace-pre-wrap for text formatting -->
            <div class="bg-slate-50 dark:bg-slate-800 p-5 rounded-lg overflow-y-auto border border-slate-200 dark:border-slate-700 font-mono text-sm whitespace-pre-wrap flex-1 shadow-inner text-slate-700 dark:text-slate-300" id="modalContent"></div>
            <div id="modalPhoto" class="mt-4 hidden"></div>
            <div class="mt-6 flex justify-end">
                <button onclick="document.getElementById('reportModal').classList.add('hidden'); document.getElementById('reportModal').classList.remove('flex')" class="bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-800 dark:text-white font-bold py-3 px-8 rounded-lg transition-colors shadow-sm">–ó–∞–∫—Ä–∏—Ç–∏</button>
            </div>
        </div>
    </div>

    <script>
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzoChS_W73edAjNbE1yhsB_P3sKq7UI1Ai6LilEFXxWI5zFntG2OxPdHwIADecqraTA/exec";
        const employees = ["–°–æ–±–æ—Ç–æ–≤–∏—á –õ.–ú.", "–û–≥–∞—Ä–∫–æ–≤–∞ –ú.–í.", "–Ü–Ω—à–∏–π"];
        let currentData = []; // Store fetched data to access details

        const empSel = document.getElementById('filter-employee');
        employees.forEach(e => empSel.add(new Option(e, e)));

        const today = new Date().toISOString().split('T')[0];
        document.getElementById('filter-date-start').value = today;
        document.getElementById('filter-date-end').value = today;

        document.getElementById('themeToggle').addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
        });
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        }

        function showToast(message) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `bg-white dark:bg-slate-700 border-l-4 border-fuchsia-500 p-4 rounded-lg shadow-xl flex items-center max-w-sm text-fuchsia-700 dark:text-fuchsia-400 border border-slate-200 dark:border-slate-600 animate-fade-in-right transform transition-all duration-300 translate-x-0`;
            toast.innerHTML = `<span class="font-medium text-sm">${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => { 
                toast.classList.add('opacity-0', 'translate-x-full');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        async function fetchData() {
            const btnText = document.getElementById('btn-text');
            const btnSpinner = document.getElementById('btn-spinner');
            
            btnText.classList.add('hidden');
            btnSpinner.classList.remove('hidden');

            const filters = {
                action: 'getData', // Key for backend
                dateStart: document.getElementById('filter-date-start').value,
                dateEnd: document.getElementById('filter-date-end').value,
                employee: document.getElementById('filter-employee').value,
                section: document.getElementById('filter-section').value
            };

            try {
                // REAL FETCH ATTEMPT
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(filters)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                currentData = data; // Store data globally
                
                renderTable(data);
                document.getElementById('resultsArea').classList.remove('hidden');
                document.getElementById('recordCount').innerText = data ? data.length : 0;
                
                if (data && data.length > 0) {
                    showToast(`–ó–Ω–∞–π–¥–µ–Ω–æ –∑–∞–ø–∏—Å—ñ–≤: ${data.length}`);
                } else {
                    showToast("–ó–∞–ø–∏—Å—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ");
                }

            } catch (e) {
                console.error(e);
                showToast("–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö (–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è)");
                renderTable([]);
                document.getElementById('resultsArea').classList.remove('hidden');
            } finally {
                btnText.classList.remove('hidden');
                btnSpinner.classList.add('hidden');
            }
        }

        function renderTable(data) {
            const tbody = document.getElementById('dataTableBody');
            const emptyState = document.getElementById('emptyState');
            tbody.innerHTML = '';

            if (!data || data.length === 0) {
                emptyState.classList.remove('hidden');
                if(data && data.result === 'error') {
                     emptyState.innerHTML = `<span class="text-red-500 font-bold">–ü–æ–º–∏–ª–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${data.error}</span>`;
                } else {
                     emptyState.innerHTML = `<svg class="w-12 h-12 mb-3 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><span>–î–∞–Ω–∏—Ö –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∑–∞ –≤–∫–∞–∑–∞–Ω–∏–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏.</span>`;
                }
                return;
            } else {
                emptyState.classList.add('hidden');
            }

            data.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.className = "bg-white dark:bg-slate-800 hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors border-b border-slate-100 dark:border-slate-700/50 last:border-0";
                
                let statusBadge = '';
                if(row.status.includes('FAIL') || row.status.includes('–ù–µ') || row.status.includes('Incomplete')) {
                    statusBadge = `<span class="bg-red-100 text-red-800 text-xs font-bold px-2.5 py-1 rounded-full dark:bg-red-900/30 dark:text-red-300 flex items-center gap-1 w-fit"><span class="w-1.5 h-1.5 rounded-full bg-red-500"></span>–ü—Ä–æ–±–ª–µ–º–∞</span>`;
                } else {
                    statusBadge = `<span class="bg-emerald-100 text-emerald-800 text-xs font-bold px-2.5 py-1 rounded-full dark:bg-emerald-900 dark:text-emerald-300 flex items-center gap-1 w-fit"><span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>OK</span>`;
                }

                tr.innerHTML = `
                    <td class="px-6 py-4 font-medium whitespace-nowrap text-slate-700 dark:text-slate-300">
                        ${row.time}
                    </td>
                    <td class="px-6 py-4 text-slate-600 dark:text-slate-300 font-medium">
                        ${row.employee}
                    </td>
                    <td class="px-6 py-4 text-slate-500 dark:text-slate-400">
                        <span class="bg-slate-100 dark:bg-slate-700 px-2 py-1 rounded text-xs font-bold uppercase tracking-wide text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-600">${translateSection(row.section)}</span>
                    </td>
                    <td class="px-6 py-4 text-slate-500 dark:text-slate-400">
                        <div class="flex flex-col gap-1">
                            ${statusBadge}
                            <span class="truncate max-w-[150px] text-xs opacity-75" title="${row.summary}">${row.summary}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-center no-print">
                        <button onclick="openReport(${index})" class="text-fuchsia-600 hover:text-fuchsia-800 dark:text-fuchsia-400 dark:hover:text-fuchsia-300 font-bold text-sm bg-fuchsia-50 dark:bg-fuchsia-900/20 px-3 py-1.5 rounded-lg transition-colors border border-fuchsia-100 dark:border-fuchsia-800 hover:border-fuchsia-300">
                            –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function openReport(index) {
            if (!currentData || !currentData[index]) return;
            const row = currentData[index];
            const reportText = row.report || "–ù–µ–º–∞—î –¥–µ—Ç–∞–ª–µ–π";
            
            // Set text content to display raw text with formatting (newlines, emojis)
            document.getElementById('modalContent').textContent = reportText;

            // Handle photo
            const photoContainer = document.getElementById('modalPhoto');
            photoContainer.innerHTML = '';
            photoContainer.classList.add('hidden');

            if (row.photo) {
                let imgSrc = row.photo;
                if (!imgSrc.startsWith('data:image')) imgSrc = 'data:image/jpeg;base64,' + imgSrc; 
                
                const imgLabel = document.createElement('strong');
                imgLabel.className = "block mb-2 text-slate-700 dark:text-slate-200 border-t pt-4 mt-4 border-slate-200 dark:border-slate-700";
                imgLabel.textContent = "üì∑ –§–æ—Ç–æ–¥–æ–∫–∞–∑:";
                
                const img = document.createElement('img');
                img.src = imgSrc;
                img.className = "max-w-full rounded-lg shadow-md border border-slate-200 dark:border-slate-700";
                
                photoContainer.appendChild(imgLabel);
                photoContainer.appendChild(img);
                photoContainer.classList.remove('hidden');
            }

            document.getElementById('reportModal').classList.remove('hidden');
            document.getElementById('reportModal').classList.add('flex');
        }

        function translateSection(sec) {
            const map = {
                'checklist': '–ß–µ–∫-–ª–∏—Å—Ç',
                'sauce_boiling': '–í–∞—Ä–∫–∏ —Å–æ—É—Å—É',
                'labeling': '–ï—Ç–∏–∫–µ—Ç—É–≤–∞–Ω–Ω—è',
                'packing': '–§–∞—Å—É–≤–∞–Ω–Ω—è',
                'cleaning': '–ú–∏–π–∫–∏',
                'hvo_control': '–•–í–û'
            };
            return map[sec] || sec;
        }
    </script>
</body>
</html>
