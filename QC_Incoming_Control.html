<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í—Ö—ñ–¥–Ω–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å | QC Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: { colors: { slate: { 50: '#f8fafc', 800: '#1e293b', 900: '#0f172a' }, teal: { 500: '#14b8a6', 600: '#0d9488', 700: '#0f766e' } } }
            }
        }
    </script>
    <style>
        :root { --bg-color: #f8fafc; --card-bg: #fff; --text: #1e293b; }
        .dark { --bg-color: #0f172a; --card-bg: #1e293b; --text: #f1f5f9; }
        body { background-color: var(--bg-color); color: var(--text); padding-bottom: 2rem; transition: background-color 0.3s ease; }
        .card { background-color: var(--card-bg); transition: background-color 0.3s ease; }
        
        input, select, textarea {
            background-color: transparent;
            width: 100%;
            color: inherit;
        }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #14b8a6; box-shadow: 0 0 0 2px rgba(20, 184, 166, 0.2); }
        
        /* –°—Ç–∏–ª—å –¥–ª—è –ø—É—Å—Ç–∏—Ö —Å–µ–ª–µ–∫—Ç—ñ–≤ */
        select:required:invalid { color: #94a3b8; }
        option[value=""][disabled] { display: none; }
        option { color: var(--text); }

        .spinner { border: 3px solid rgba(0,0,0,0.1); width: 24px; height: 24px; border-radius: 50%; border-left-color: #14b8a6; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        .modal-overlay { background-color: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 50; }
        .input-alert { border-color: #ef4444 !important; background-color: rgba(239, 68, 68, 0.05) !important; }
        
        /* Styles for photo gallery */
        .photo-preview-item { position: relative; width: 100%; padding-top: 100%; }
        .photo-preview-item img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; border-radius: 0.5rem; border: 1px solid #e2e8f0; }
        .photo-remove-btn { position: absolute; top: -5px; right: -5px; background: #ef4444; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    </style>
</head>
<body class="font-sans antialiased">
    
    <div id="toast-container" class="fixed top-4 right-4 z-[2000] flex flex-col gap-2"></div>

    <div class="container mx-auto max-w-3xl p-4 sm:p-6 lg:p-8">
        <header class="flex items-center gap-4 mb-8">
            <a href="index.html" class="p-3 bg-white dark:bg-slate-800 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 text-slate-500 hover:text-teal-600 transition-colors flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" /></svg>
                <span class="font-bold hidden sm:inline">–ú–µ–Ω—é</span>
            </a>
            
            <div class="flex-1 text-center">
                <h1 class="text-3xl font-bold text-teal-700 dark:text-teal-500">–í—Ö—ñ–¥–Ω–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å</h1>
                <p class="text-teal-600 dark:text-teal-400 text-sm font-bold mt-1 uppercase tracking-wide">–°–∏—Ä–æ–≤–∏–Ω–∞ —Ç–∞ –ú–∞—Ç–µ—Ä—ñ–∞–ª–∏</p>
            </div>
            
             <!-- Icon for Incoming -->
             <div class="p-2 text-teal-500">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                    <polyline points="7.5 4.21 12 6.81 16.5 4.21"></polyline>
                    <polyline points="7.5 19.79 7.5 14.6 3 12"></polyline>
                    <polyline points="21 12 16.5 14.6 16.5 19.79"></polyline>
                    <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                    <line x1="12" y1="22.08" x2="12" y2="12"></line>
                </svg>
            </div>
            
            <button id="themeToggle" class="p-3 rounded-lg text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
            </button>
        </header>

        <div class="card p-8 rounded-lg shadow-lg border border-slate-200 dark:border-slate-700 space-y-6 relative">
            <button onclick="resetForm()" class="absolute top-4 right-4 text-xs font-bold text-orange-600 hover:text-orange-800 bg-orange-100 hover:bg-orange-200 px-3 py-1.5 rounded-lg transition-colors dark:bg-orange-900/30 dark:text-orange-300 border border-transparent hover:border-orange-300">–°–∫–∏–Ω—É—Ç–∏</button>

            <!-- 1. General Info -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 mt-4">
                <div>
                    <label class="block text-sm font-bold text-slate-500 dark:text-slate-400 uppercase mb-2">–ö–æ–Ω—Ç—Ä–æ–ª–µ—Ä *</label>
                    <select id="employeeSelect" class="w-full bg-transparent border-2 border-slate-300 dark:border-slate-600 rounded-lg py-4 px-4 text-lg transition-colors"><option value="">–û–±–µ—Ä—ñ—Ç—å...</option></select>
                </div>
                <div>
                    <label class="block text-sm font-bold text-slate-500 dark:text-slate-400 uppercase mb-2">–î–∞—Ç–∞ —Ç–∞ –ß–∞—Å *</label>
                    <input type="datetime-local" id="inc-datetime" class="w-full bg-transparent border-2 border-slate-300 dark:border-slate-600 rounded-lg py-4 px-4 text-lg transition-colors">
                </div>
            </div>

            <!-- 2. Supplier & Doc Info -->
             <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-bold text-slate-500 dark:text-slate-400 uppercase mb-2">–ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫ / –í–∏—Ä–æ–±–Ω–∏–∫ *</label>
                    <input type="text" id="inc-supplier" placeholder="–ù–∞–∑–≤–∞ –ø–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫–∞..." class="w-full bg-transparent border-2 border-slate-300 dark:border-slate-600 rounded-lg py-4 px-4 text-lg transition-colors">
                </div>
                <div>
                    <label class="block text-sm font-bold text-slate-500 dark:text-slate-400 uppercase mb-2">‚Ññ –î–æ–∫—É–º–µ–Ω—Ç–∞ (–¢–¢–ù/–Ü–Ω–≤–æ–π—Å) *</label>
                    <input type="text" id="inc-doc-num" placeholder="‚Ññ..." class="w-full bg-transparent border-2 border-slate-300 dark:border-slate-600 rounded-lg py-4 px-4 text-lg transition-colors">
                </div>
            </div>

            <!-- 3. Product Selection -->
            <div class="bg-teal-50 dark:bg-slate-800/80 p-5 rounded-lg border border-teal-100 dark:border-slate-700 space-y-4">
                <h3 class="text-sm font-bold text-teal-800 dark:text-teal-400 uppercase mb-2 border-b border-teal-200 dark:border-slate-600 pb-2">–Ü–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è —Ç–æ–≤–∞—Ä—É</h3>
                
                <div>
                    <label class="block text-sm font-bold text-slate-500 dark:text-slate-400 uppercase mb-2">–ö–∞—Ç–µ–≥–æ—Ä—ñ—è *</label>
                    <select id="inc-category" class="w-full bg-white dark:bg-slate-900 border-2 border-slate-300 dark:border-slate-600 rounded-lg py-3 px-4 text-lg transition-colors" onchange="updateProductList()">
                        <option value="" disabled selected>–û–±–µ—Ä—ñ—Ç—å –∫–∞—Ç–µ–≥–æ—Ä—ñ—é...</option>
                        <option value="raw">–°–∏—Ä–æ–≤–∏–Ω–∞ / –Ü–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∏</option>
                        <option value="packaging">–¢–∞—Ä–∞ —Ç–∞ –£–ø–∞–∫–æ–≤–∫–∞</option>
                        <option value="label">–ï—Ç–∏–∫–µ—Ç–∫–∞</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-bold text-slate-500 dark:text-slate-400 uppercase mb-2">–ù–∞–∑–≤–∞ (–ê—Ä—Ç–∏–∫—É–ª) *</label>
                    <input type="text" id="inc-product-input" list="product-datalist" placeholder="–ü–æ—á–Ω—ñ—Ç—å –≤–≤–æ–¥–∏—Ç–∏ –Ω–∞–∑–≤—É –∞–±–æ –∫–æ–¥..." class="w-full bg-white dark:bg-slate-900 border-2 border-slate-300 dark:border-slate-600 rounded-lg py-3 px-4 text-lg transition-colors" autocomplete="off">
                    <datalist id="product-datalist"></datalist>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                     <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">‚Ññ –ü–∞—Ä—Ç—ñ—ó (Batch)</label>
                        <input type="text" id="inc-batch" class="w-full p-2 border rounded bg-white dark:bg-slate-900 border-slate-300 dark:border-slate-600">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">–ö—ñ–ª—å–∫—ñ—Å—Ç—å (–∫–≥/—à—Ç)</label>
                        <input type="text" id="inc-qty" class="w-full p-2 border rounded bg-white dark:bg-slate-900 border-slate-300 dark:border-slate-600">
                    </div>
                     <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">–î–∞—Ç–∞ –≤–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–∞</label>
                        <input type="date" id="inc-prod-date" class="w-full p-2 border rounded bg-white dark:bg-slate-900 border-slate-300 dark:border-slate-600">
                    </div>
                     <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">–¢–µ—Ä–º—ñ–Ω –ø—Ä–∏–¥–∞—Ç–Ω–æ—Å—Ç—ñ (–¥–æ)</label>
                        <input type="date" id="inc-exp-date" class="w-full p-2 border rounded bg-white dark:bg-slate-900 border-slate-300 dark:border-slate-600">
                    </div>
                </div>
            </div>

            <!-- 4. Control Points -->
            <div class="bg-slate-50 dark:bg-slate-800/50 p-5 rounded-lg border border-slate-200 dark:border-slate-700">
                <h3 class="text-sm font-bold text-slate-600 dark:text-slate-300 uppercase mb-4 border-b border-slate-200 dark:border-slate-600 pb-2">–†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –∫–æ–Ω—Ç—Ä–æ–ª—é</h3>
                
                <div class="space-y-3">
                    <div class="flex items-center justify-between gap-4 border-b border-slate-100 dark:border-slate-700 pb-2">
                        <label class="text-sm font-bold text-slate-700 dark:text-slate-200 flex-1">–°–∞–Ω—ñ—Ç–∞—Ä–Ω–∏–π —Å—Ç–∞–Ω —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç—É</label>
                        <select id="check-transport" class="w-40 bg-white dark:bg-slate-900 border-2 border-slate-300 dark:border-slate-600 rounded-lg py-2 px-3 text-sm font-bold cursor-pointer" onchange="checkStatus(this)">
                            <option value="" disabled selected>–û–±–µ—Ä—ñ—Ç—å...</option>
                            <option value="‚úÖ –í—ñ–¥–ø–æ–≤—ñ–¥–∞—î">‚úÖ –í—ñ–¥–ø–æ–≤—ñ–¥–∞—î</option>
                            <option value="‚ùå –ë—Ä—É–¥/–®–∫—ñ–¥–Ω–∏–∫–∏">‚ùå –ë—Ä—É–¥/–®–∫—ñ–¥–Ω–∏–∫–∏</option>
                        </select>
                    </div>

                    <div class="flex items-center justify-between gap-4 border-b border-slate-100 dark:border-slate-700 pb-2">
                         <label class="text-sm font-bold text-slate-700 dark:text-slate-200 flex-1">–¶—ñ–ª—ñ—Å–Ω—ñ—Å—Ç—å –ø–∞–∫—É–≤–∞–Ω–Ω—è</label>
                        <select id="check-package" class="w-40 bg-white dark:bg-slate-900 border-2 border-slate-300 dark:border-slate-600 rounded-lg py-2 px-3 text-sm font-bold cursor-pointer" onchange="checkStatus(this)">
                            <option value="" disabled selected>–û–±–µ—Ä—ñ—Ç—å...</option>
                            <option value="‚úÖ –¶—ñ–ª–µ">‚úÖ –¶—ñ–ª–µ</option>
                            <option value="‚ùå –ü–æ—à–∫–æ–¥–∂–µ–Ω–µ">‚ùå –ü–æ—à–∫–æ–¥–∂–µ–Ω–µ</option>
                        </select>
                    </div>

                     <div class="flex items-center justify-between gap-4 border-b border-slate-100 dark:border-slate-700 pb-2">
                         <label class="text-sm font-bold text-slate-700 dark:text-slate-200 flex-1">–í—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ—Å—Ç—å –º–∞—Ä–∫—É–≤–∞–Ω–Ω—è</label>
                        <select id="check-marking" class="w-40 bg-white dark:bg-slate-900 border-2 border-slate-300 dark:border-slate-600 rounded-lg py-2 px-3 text-sm font-bold cursor-pointer" onchange="checkStatus(this)">
                            <option value="" disabled selected>–û–±–µ—Ä—ñ—Ç—å...</option>
                            <option value="‚úÖ –í—ñ–¥–ø–æ–≤—ñ–¥–∞—î">‚úÖ –í—ñ–¥–ø–æ–≤—ñ–¥–∞—î</option>
                            <option value="‚ùå –ü–æ–º–∏–ª–∫–∞">‚ùå –ü–æ–º–∏–ª–∫–∞</option>
                        </select>
                    </div>

                    <div class="flex items-center justify-between gap-4 border-b border-slate-100 dark:border-slate-700 pb-2">
                         <label class="text-sm font-bold text-slate-700 dark:text-slate-200 flex-1">–°—É–ø—Ä–æ–≤—ñ–¥–Ω—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∏ (–Ø–∫—ñ—Å—Ç—å)</label>
                        <select id="check-docs" class="w-40 bg-white dark:bg-slate-900 border-2 border-slate-300 dark:border-slate-600 rounded-lg py-2 px-3 text-sm font-bold cursor-pointer" onchange="checkStatus(this)">
                            <option value="" disabled selected>–û–±–µ—Ä—ñ—Ç—å...</option>
                            <option value="‚úÖ –ù–∞—è–≤–Ω—ñ/–û–ö">‚úÖ –ù–∞—è–≤–Ω—ñ/–û–ö</option>
                            <option value="‚ùå –í—ñ–¥—Å—É—Ç–Ω—ñ/–ù–µ –∫–æ—Ä–µ–∫—Ç–Ω—ñ">‚ùå –í—ñ–¥—Å—É—Ç–Ω—ñ/Bad</option>
                        </select>
                    </div>
                    
                    <div class="flex items-center justify-between gap-4">
                         <label class="text-sm font-bold text-slate-700 dark:text-slate-200 flex-1">–û—Ä–≥–∞–Ω–æ–ª–µ–ø—Ç–∏–∫–∞ / –ó–æ–≤–Ω—ñ—à–Ω—ñ–π –≤–∏–≥–ª—è–¥</label>
                        <select id="check-organoleptic" class="w-40 bg-white dark:bg-slate-900 border-2 border-slate-300 dark:border-slate-600 rounded-lg py-2 px-3 text-sm font-bold cursor-pointer" onchange="checkStatus(this)">
                            <option value="" disabled selected>–û–±–µ—Ä—ñ—Ç—å...</option>
                            <option value="‚úÖ –í—ñ–¥–ø–æ–≤—ñ–¥–∞—î">‚úÖ –í—ñ–¥–ø–æ–≤—ñ–¥–∞—î</option>
                            <option value="‚ùå –ù–µ–≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ—Å—Ç—å">‚ùå –ù–µ–≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ—Å—Ç—å</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="bg-slate-100 dark:bg-slate-800 p-4 rounded-lg border border-slate-200 dark:border-slate-700">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h4 class="font-bold text-sm mb-1 text-slate-700 dark:text-slate-200">–§–æ—Ç–æ –∑–≤—ñ—Ç</h4>
                        <p class="text-xs text-slate-500 dark:text-slate-400">–ú–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –¥–µ–∫—ñ–ª—å–∫–∞ —Ñ–æ—Ç–æ</p>
                    </div>
                    <label class="cursor-pointer bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg shadow flex items-center gap-2 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        <span>–û–±—Ä–∞—Ç–∏ —Ñ–æ—Ç–æ</span>
                        <input type="file" id="photo-upload" accept="image/*" multiple class="hidden" onchange="handleFiles(this)">
                    </label>
                </div>
                
                <div id="gallery-container" class="grid grid-cols-3 gap-2 hidden">
                </div>
            </div>

            <textarea id="inc-comment" class="w-full bg-transparent border-2 border-slate-300 dark:border-slate-600 rounded-lg py-4 px-4 text-lg focus:outline-none focus:border-teal-500 transition-colors" rows="2" placeholder="–ö–æ–º–µ–Ω—Ç–∞—Ä / –û–ø–∏—Å –Ω–µ–≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ—Å—Ç–µ–π..."></textarea>

            <button onclick="initiateSend()" class="w-full mt-8 bg-teal-600 hover:bg-teal-700 text-white font-bold py-4 rounded-lg shadow-lg active:scale-95 transition-transform flex justify-center items-center gap-2 text-lg"><span>üì§ –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –∑–≤—ñ—Ç</span></button>
        </div>
    </div>

    <!-- Modals -->
    <div id="confirmationModal" class="hidden fixed inset-0 items-center justify-center modal-overlay p-4 z-50"><div class="card p-8 rounded-lg shadow-2xl max-w-sm w-full"><h3 class="font-bold text-xl mb-3 text-center">–°–∫–∏–¥–∞–Ω–Ω—è</h3><p class="mb-8 text-center text-slate-500">–û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å—é —Ñ–æ—Ä–º—É?</p><div class="flex justify-center gap-4"><button onclick="closeModal('confirmationModal')" class="px-6 py-3 bg-slate-100 rounded-lg font-bold">–ù—ñ</button><button onclick="performReset()" class="px-6 py-3 bg-red-600 text-white rounded-lg font-bold">–¢–∞–∫</button></div></div></div>
    
    <div id="sendModal" class="hidden fixed inset-0 items-center justify-center modal-overlay p-4 z-50">
        <div class="card p-8 rounded-lg shadow-2xl w-full max-w-md flex flex-col max-h-[90vh]">
            <div class="text-center mb-4">
                <div class="text-4xl mb-2">üì§</div>
                <h3 class="text-xl font-bold">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏</h3>
                <p class="text-sm text-slate-500">–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –≤–≤–µ–¥–µ–Ω—ñ –¥–∞–Ω—ñ</p>
            </div>
            <div class="bg-slate-50 dark:bg-slate-800 p-5 rounded-lg overflow-y-auto mb-6 text-sm font-mono whitespace-pre-wrap flex-1 shadow-inner max-h-80" id="reportPreview"></div>
            <p id="sendStatus" class="text-center text-lg font-bold mb-4 text-emerald-600 min-h-[1.5em]"></p>
            <div id="sendActions" class="flex flex-col gap-3">
                <button id="confirmSendBtn" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-4 rounded-lg shadow-lg text-lg">‚úÖ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏</button>
                <button onclick="closeModal('sendModal')" class="w-full bg-transparent border-2 border-slate-300 hover:bg-slate-100 text-slate-500 font-bold py-4 rounded-lg text-lg">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
            </div>
            <div id="sendSpinner" class="hidden py-6 flex justify-center"><div class="spinner"></div></div>
        </div>
    </div>

    <script>
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzBNKzf5ThGoUSAUHbwkdlFozy2LVgiTXaQok63eAkJoe2dvKbAjvAfOx8LtiLpaCgfhg/exec";
        const employees = ["–°–æ–±–æ—Ç–æ–≤–∏—á –õ.–ú.", "–û–≥–∞—Ä–∫–æ–≤–∞ –ú.–í.", "–Ü–Ω—à–∏–π"];
        
        // --- Database constructed from uploaded files ---
        const itemsDatabase = {
            "raw": [
                "ADD-D-001 –ê–Ω—Ç–∏–æ–∫—Å–∏–¥–∞–Ω—Ç", "SPC-D-001 –ê–ø–µ–ª—å—Å–∏–Ω —Å–∏—Ü–∏–ª—ñ—è —á—ñ–ø—Å–∏", "SPC-D-002 –ê–ø–µ–ª—å—Å–∏–Ω —á—ñ–ø—Å–∏", "SPC-D-003 –ê–ø–µ–ª—å—Å–∏–Ω—É —à–∫—ñ—Ä–∫–∞", 
                "NUT-D-001 –ê—Ä–∞—Ö—ñ—Å –±–ª–∞–Ω—à–æ–≤–∞–Ω–∏–π", "1046 –ê—Ä–∞—Ö—ñ—Å –∂–∞—Ä–µ–Ω–∏–π (KV-00015305)", "ARO-L-001 –ê—Ä–æ–º–∞—Ç–∏–∑–∞—Ç–æ—Ä –ê–±—Ä–∏–∫–æ—Å", 
                "ARO-L-002 –ê—Ä–æ–º–∞—Ç–∏–∑–∞—Ç–æ—Ä –ê–ø–µ–ª—å—Å–∏–Ω", "ARO-L-003 –ê—Ä–æ–º–∞—Ç–∏–∑–∞—Ç–æ—Ä –ê—Ä–∞—Ö—ñ—Å", "ARO-L-004 –ê—Ä–æ–º–∞—Ç–∏–∑–∞—Ç–æ—Ä –ë–∞–∑–∏–ª—ñ–∫", 
                "ARO-D-008 –ê—Ä–æ–º–∞—Ç–∏–∑–∞—Ç–æ—Ä –ë–µ–∫–æ–Ω", "ARO-L-009 –ê—Ä–æ–º–∞—Ç–∏–∑–∞—Ç–æ—Ä –í–∞—Å–∞–±—ñ", "ARO-L-010 –ê—Ä–æ–º–∞—Ç–∏–∑–∞—Ç–æ—Ä –í–∏–Ω–æ–≥—Ä–∞–¥",
                "1107 –û—Ä–µ–≥–∞–Ω–æ (KV-00012089)", "1108 –ê—Ä–æ–º–∞—Ç–∏–∑–∞—Ç–æ—Ä –°–∏—Ä –ß–µ–¥–¥–µ—Ä (KV-00019330)", "1109 –°—É–º—ñ—à –î–æ —Ä–∏–±–∏ (KV-00011702)",
                "1110 –ù–∞—Ç—Ä—ñ–π —Ü–∏—Ç—Ä–∞—Ç (KV-00018260)", "1111 –ë–∞—Ä–≤–Ω–∏–∫ –°–∏–Ω—ñ–π –±–ª–∏—Å–∫—É—á–∏–π (KV-00041494)", "1112 –°–∏—Ä–æ–≤–∞—Ç–∫–∞ —Å—É—Ö–∞ –º–æ–ª–æ—á–Ω–∞ (KV-00019255)",
                "1113 –õ–∞–≤—Ä–æ–≤–∏–π –ª–∏—Å—Ç –º–µ–ª–µ–Ω–∏–π (KV-00031636)", "1114 –ß–µ–±—Ä–µ—Ü—å —Å–æ—Ä—Ç –ê (KV-00020907)", "1115 –ö–º–∏–Ω (KV-00014948)",
                "1116 –ù–∞—Ç—Ä—ñ—é EDTA (KV-00017310)", "1117 –ë–∞—Ä–≤–Ω–∏–∫ –¢–∞—Ä—Ç—Ä–∞–∑–∏–Ω (KV-00011705)", "1118 –§–µ–Ω—Ö–µ–ª—å –º–µ–ª–µ–Ω–∏–π (KV-00020904)",
                "1119 –ì—ñ—Ä—á–∏—á–Ω–∏–π –ø–æ—Ä–æ—à–æ–∫ (KV-00011026)", "1121 –£—Å—Ç—Ä–∏—á–Ω–∏–π –ø–æ—Ä–æ—à–æ–∫", "1125 –°–æ—î–≤–∏–π —Å–æ—É—Å –ø–æ—Ä–æ—à–æ–∫ (SSP-N)",
                "1128 –ú–µ–ª—è—Å–∞ –±—É—Ä—è–∫–æ–≤–∞", "1129 –û—Ü–µ—Ç –ø—Ä—è–Ω–∏–π –≤–∏–Ω–Ω–∏–π Kuhne", "1004 –°–æ–µ–≤—ã–π —Å–æ—É—Å –ø–æ—Ä–æ—à–æ–∫ (SSP-J)", "1009 –°–æ–µ–≤—ã–π —Å–æ—É—Å –ø–æ—Ä–æ—à–æ–∫ (SSP-J)",
                "1020 –°–æ–µ–≤—ã–π —Å–æ—É—Å –ø–æ—Ä–æ—à–æ–∫ (SSP-N2) –ß—É–º–∞–∫", "1012 –û–ª—ñ—è –∫—É–Ω–∂—É—Ç–Ω–∞", "1016 –û–ª—ñ—è —Å–æ–Ω—è—à–Ω–∏–∫–æ–≤–∞", "1043 –ú–µ–¥ –±–¥–∂–æ–ª–∏–Ω–∏–π",
                "1071 –°—É–º—ñ—à –ü—Ä–æ–≤–∞–Ω—Å—å–∫—ñ —Ç—Ä–∞–≤–∏", "1076 –°—É–º—ñ—à –Ü—Ç–∞–ª—ñ–π—Å—å–∫—ñ —Ç—Ä–∞–≤–∏", "1074 –¶–µ–¥—Ä–∞ –∞–ø–µ–ª—å—Å–∏–Ω—É –º–µ–ª–µ–Ω–∞", "1082 –ï–∫—Å—Ç—Ä–∞–∫—Ç –¶–∏–±—É–ª—ñ",
                "1023 –ê—Ä–æ–º–∞—Ç–∏–∑–∞—Ç–æ—Ä –¢–æ–º–∞—Ç—ñ–≤ –î–∂–æ—Ç—Ç—ñ", "1013 –ë–∞—Ä–≤–Ω–∏–∫ –Ω–∞—Ç—É—Ä–∞–ª—å–Ω–∏–π –∫–∞—Ä–∞–º–µ–ª—å", "1035 –°–∏—Ä –ß–µ–¥–¥–µ—Ä Dublin Dairy", "1092 –°–∏—Ä –ü–∞—Ä–º—ñ–¥–∂—ñ–∞–Ω–æ –†–µ–¥–∂—ñ–∞–Ω–æ"
            ],
            "packaging": [
                "2013 –ë–∞–Ω–∫–∞ —Å–∫–ª–æ 212 ml", "3157 –ë–∞–Ω–∫–∞ —Å–∫–ª–æ 370 ml", "2032 –í—ñ–¥—Ä–æ 1–ª (–±—ñ–ª–µ EL) Peri", "2035 –ì–æ—Ñ—Ä–æ–∫–æ—Ä–æ–± 360*290*110",
                "2038 –ì–æ—Ñ—Ä–æ–ª–∏—Å—Ç 355*285", "2037 –ì–æ—Ñ—Ä–æ–ø—Ä–æ–∫–ª–∞–¥–∫–∞ 1180*760", "3141 –ì–æ—Ñ—Ä–æ–ø—Ä–æ–∫–ª–∞–¥–∫–∞ 1200*800", "3153 –ì–æ—Ñ—Ä–æ—è—â–∏–∫ 150*110*250",
                "3156 –ì–æ—Ñ—Ä–æ—è—â–∏–∫ 360*185*105", "3154 –î–æ–∑–∞—Ç–æ—Ä –∑ –≥–≤–∏–Ω—Ç–æ–≤–∏–º –∫–æ–≤–ø–∞—á–∫–æ–º", "2034 –ü–ª—ñ–≤–∫–∞ –ü–í–• —Ç–µ—Ä–º–æ–∑–±—ñ–∂–Ω–∞ 400*70",
                "2042 –ü–ª—ñ–≤–∫–∞ —Å—Ç—Ä–µ–π—á 1500/23", "2041 –ü–ª—ñ–≤–∫–∞ —Å—Ç—Ä–µ–π—á –º–∞—à–∏–Ω–Ω–∞ 500/23", "2014 –ü–ª—è—à–∫–∞ –ü–ï–¢ 1000 –º–ª Bonsai Premium",
                "2010 –ü–ª—è—à–∫–∞ –ü–ï–¢ 1000 –º–ª –§—É–¥–ª–∞–π–Ω", "2024 –ü–ª—è—à–∫–∞ –ü–ï–¢ 1000 –º–ª –ß—É–º–∞–∫/–õ—é–±–∏—Å—Ç–æ–∫", "3146 –ü–ª—è—à–∫–∞ –ü–ï–¢ 1000 –º–ª 38 –º–º",
                "2006 –ü–ª—è—à–∫–∞ –ü–ï–¢ 205 –º–ª YKI", "2028 –ü–ª—è—à–∫–∞ –ü–ï–¢ 220 –º–ª Bonsai GOLD", "2005 –ü–ª—è—à–∫–∞ –ü–ï–¢ 235 –º–ª Bonsai",
                "2015 –ü–ª—è—à–∫–∞ –ü–ï–¢ 250 –º–ª Bonsai Premium", "2020 –ü–ª—è—à–∫–∞ –ü–ï–¢ 300 –º–ª"
            ],
            "label": [
                "3052 –ï—Ç–∏–∫–µ—Ç–∫–∞ Bonsai 1:1 Professional 1000 –º–ª", "3112 –ï—Ç–∏–∫–µ—Ç–∫–∞ Bonsai –°–æ–ª–æ–¥–∫–∏–π-–ß–∏–ª—ñ 550 –≥", "3005 –ï—Ç–∏–∫–µ—Ç–∫–∞ Bonsai –∫–ª–∞—Å–∏—á–Ω–∏–π 1000 –º–ª",
                "3004 –ï—Ç–∏–∫–µ—Ç–∫–∞ Bonsai –∫–ª–∞—Å–∏—á–Ω–∏–π 500 –º–ª", "3162 –ï—Ç–∏–∫–µ—Ç–∫–∞ Bonsai –∫–ª–∞—Å–∏—á–Ω–∏–π 750 –º–ª", "C3004 –ï—Ç–∏–∫–µ—Ç–∫–∞ Bonsai –ö–ª–∞—Å–∏—á–Ω–∏–π 750 –º–ª",
                "3135 –ï—Ç–∏–∫–µ—Ç–∫–∞ Bonsai –£–ù–ê–ì–Ü 500 –º–ª", "3142 –ï—Ç–∏–∫–µ—Ç–∫–∞ –°–≤–æ—î,—Å–≤—ñ–∂–µ –ö–µ—Ç—á—É–ø —á–∏–ª—ñ", "3143 –ï—Ç–∏–∫–µ—Ç–∫–∞ –°–≤–æ—î,—Å–≤—ñ–∂–µ –ö–µ—Ç—á—É–ø",
                "3121 –ï—Ç–∏–∫–µ—Ç–∫–∞ –°–≤–æ—î,—Å–≤—ñ–∂–µ –ö–∏—Å–ª–æ-—Å–æ–ª–æ–¥–∫–∏–π", "3105 –ï—Ç–∏–∫–µ—Ç–∫–∞ –°–≤–æ—î,—Å–≤—ñ–∂–µ –°–æ–ª–æ–¥–∫–∏–π —á–∏–ª—ñ", "3136 –ï—Ç–∏–∫–µ—Ç–∫–∞ –°–≤–æ—î,—Å–≤—ñ–∂–µ –¢–∞—Ä—Ç–∞—Ä",
                "3013 –ï—Ç–∏–∫–µ—Ç–∫–∞ –°–µ–∫—Ä–µ—Ç–∏ –®–µ—Ñ–∞ –°–æ—î–≤–∏–π 205 –º–ª", "3026 –ï—Ç–∏–∫–µ—Ç–∫–∞ –°–µ–∫—Ä–µ—Ç–∏ –®–µ—Ñ–∞ –¢–µ—Ä—ñ—è–∫—ñ 220 –≥", "3062 –ï—Ç–∏–∫–µ—Ç–∫–∞ –°–µ–∫—Ä–µ—Ç–∏ –®–µ—Ñ–∞ –°–æ—î–≤–∏–π 470 –º–ª",
                "123 –ï—Ç–∏–∫–µ—Ç–∫–∞ Bonsai –Ø–ö–Ü–¢–û–†–Ü 220 –º–ª", "123 –ï—Ç–∏–∫–µ—Ç–∫–∞ YKI –ö–ª–∞—Å–∏—á–Ω–∏–π 235 –º–ª", "123 –ï—Ç–∏–∫–µ—Ç–∫–∞ YKI –¢–ï–†–Ü–Ø–ö–Ü –ì–£–°–¢–ò–ô 235 –º–ª"
            ]
        };

        const empSel = document.getElementById('employeeSelect');
        employees.forEach(e => empSel.add(new Option(e, e)));
        
        // Set current datetime
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('inc-datetime').value = now.toISOString().slice(0,16);

        let uploadedFiles = []; 
        let pendingData = null;

        function updateProductList() {
            const category = document.getElementById('inc-category').value;
            const datalist = document.getElementById('product-datalist');
            const input = document.getElementById('inc-product-input');
            
            datalist.innerHTML = '';
            input.value = '';

            if (category && itemsDatabase[category]) {
                itemsDatabase[category].forEach(item => {
                    const option = document.createElement('option');
                    option.value = item;
                    datalist.appendChild(option);
                });
            }
        }

        function handleFiles(input) {
            const files = input.files;
            if (files && files.length > 0) {
                const container = document.getElementById('gallery-container');
                container.classList.remove('hidden');

                Array.from(files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const base64 = e.target.result;
                        uploadedFiles.push({ name: file.name, type: file.type, data: base64 });
                        const index = uploadedFiles.length - 1;
                        const div = document.createElement('div');
                        div.className = 'photo-preview-item';
                        div.innerHTML = `<img src="${base64}"><div class="photo-remove-btn" onclick="removeFile(${index}, this)">‚úï</div>`;
                        container.appendChild(div);
                    };
                    reader.readAsDataURL(file);
                });
            }
            input.value = '';
        }

        function removeFile(index, btnElement) {
            const parent = btnElement.parentElement;
            parent.remove();
            const src = parent.querySelector('img').src;
            uploadedFiles = uploadedFiles.filter(f => f.data !== src);
            if(uploadedFiles.length === 0) document.getElementById('gallery-container').classList.add('hidden');
        }

        function checkStatus(el) {
            if (el.value.includes('‚ùå')) el.classList.add('input-alert');
            else el.classList.remove('input-alert');
        }

        function resetForm() { document.getElementById('confirmationModal').classList.remove('hidden'); document.getElementById('confirmationModal').classList.add('flex'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); document.getElementById(id).classList.remove('flex'); }
        
        function performReset() {
             document.querySelectorAll('input, textarea').forEach(el => el.value = '');
             document.querySelectorAll('select').forEach(el => { el.value = ""; el.classList.remove('input-alert'); });
             uploadedFiles = [];
             document.getElementById('gallery-container').innerHTML = '';
             closeModal('confirmationModal');
             const now = new Date(); now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
             document.getElementById('inc-datetime').value = now.toISOString().slice(0,16);
        }

        const saved = localStorage.getItem('qc_user');
        if(saved) empSel.value = saved;
        empSel.onchange = () => localStorage.setItem('qc_user', empSel.value);

        document.getElementById('themeToggle').addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
        });
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        }

        function initiateSend() {
            const emp = empSel.value;
            const supplier = document.getElementById('inc-supplier').value;
            const docNum = document.getElementById('inc-doc-num').value;
            const category = document.getElementById('inc-category').value;
            const product = document.getElementById('inc-product-input').value;
            
            if(!emp || !supplier || !docNum || !category || !product) { alert("–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –æ–±–æ–≤'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è!"); return; }

            const trans = document.getElementById('check-transport').value;
            const pack = document.getElementById('check-package').value;
            const marking = document.getElementById('check-marking').value;
            const docs = document.getElementById('check-docs').value;
            const organoleptic = document.getElementById('check-organoleptic').value;
            
            let alerts = "";
            if(trans.includes('‚ùå')) alerts += "\nüî¥ –¢–†–ê–ù–°–ü–û–†–¢: –ù–µ–≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ—Å—Ç—å";
            if(pack.includes('‚ùå')) alerts += "\nüî¥ –ü–ê–ö–£–í–ê–ù–ù–Ø: –ü–æ—à–∫–æ–¥–∂–µ–Ω–µ";
            if(marking.includes('‚ùå')) alerts += "\nüî¥ –ú–ê–†–ö–£–í–ê–ù–ù–Ø: –ü–æ–º–∏–ª–∫–∞";
            if(docs.includes('‚ùå')) alerts += "\nüî¥ –î–û–ö–£–ú–ï–ù–¢–ò: –í—ñ–¥—Å—É—Ç–Ω—ñ/–ü–æ–º–∏–ª–∫–∞";
            if(organoleptic.includes('‚ùå')) alerts += "\nüî¥ –û–†–ì–ê–ù–û–õ–ï–ü–¢–ò–ö–ê: –ù–µ–≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ—Å—Ç—å";

            let headerIcon = alerts ? "‚ö†Ô∏è" : "üì¶";

            const report = `${headerIcon} –ó–í–Ü–¢ QC Master: –í—Ö—ñ–¥–Ω–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å
===========================
üë§ –ö–æ–Ω—Ç—Ä–æ–ª–µ—Ä: ${emp}
üìÖ –î–∞—Ç–∞: ${document.getElementById('inc-datetime').value.replace('T', ' ')}
üöõ –ü–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫: ${supplier}
üìÑ ‚Ññ –î–æ–∫—É–º–µ–Ω—Ç–∞: ${docNum}

üì¶ –¢–æ–≤–∞—Ä: ${product}
üìÇ –ö–∞—Ç–µ–≥–æ—Ä—ñ—è: ${category}
üî¢ –ü–∞—Ä—Ç—ñ—è: ${document.getElementById('inc-batch').value || '-'}
‚öñÔ∏è –ö—ñ–ª—å–∫—ñ—Å—Ç—å: ${document.getElementById('inc-qty').value || '-'}
üè≠ –î–∞—Ç–∞ –≤–∏—Ä.: ${document.getElementById('inc-prod-date').value || '-'}
‚è≥ –ü—Ä–∏–¥–∞—Ç–Ω–∏–π –¥–æ: ${document.getElementById('inc-exp-date').value || '-'}

üîç –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏:
   ‚Ä¢ –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç: ${trans}
   ‚Ä¢ –ü–∞–∫—É–≤–∞–Ω–Ω—è: ${pack}
   ‚Ä¢ –ú–∞—Ä–∫—É–≤–∞–Ω–Ω—è: ${marking}
   ‚Ä¢ –î–æ–∫—É–º–µ–Ω—Ç–∏: ${docs}
   ‚Ä¢ –û—Ä–≥–∞–Ω–æ–ª–µ–ø—Ç–∏–∫–∞: ${organoleptic}

üì∑ –§–æ—Ç–æ: ${uploadedFiles.length} —à—Ç.

üí¨ –ö–æ–º–µ–Ω—Ç–∞—Ä: ${document.getElementById('inc-comment').value}
${alerts}
===========================`;

            pendingData = {
                type: 'incoming', 
                time: new Date().toLocaleString('uk-UA'),
                employee: emp,
                supplier: supplier, docNum: docNum,
                category: category, product: product,
                batch: document.getElementById('inc-batch').value,
                quantity: document.getElementById('inc-qty').value,
                prodDate: document.getElementById('inc-prod-date').value,
                expDate: document.getElementById('inc-exp-date').value,
                checkTransport: trans, checkPackage: pack, checkMarking: marking,
                checkDocs: docs, checkOrganoleptic: organoleptic,
                comment: document.getElementById('inc-comment').value,
                report: report,
                files: uploadedFiles, 
                photo: uploadedFiles.length > 0 ? uploadedFiles[0].data : ""
            };

            document.getElementById('reportPreview').innerText = report;
            document.getElementById('sendStatus').innerText = "";
            document.getElementById('sendActions').style.display = 'flex';
            document.getElementById('sendSpinner').classList.add('hidden');
            document.getElementById('sendModal').classList.remove('hidden');
            document.getElementById('sendModal').classList.add('flex');
        }

        async function executeSend() {
            const actions = document.getElementById('sendActions'); 
            const spinner = document.getElementById('sendSpinner'); 
            const status = document.getElementById('sendStatus');
            
            actions.style.display = 'none'; 
            spinner.classList.remove('hidden'); 
            status.innerText = "–í—ñ–¥–ø—Ä–∞–≤–∫–∞...";
            
            try {
                await fetch(GOOGLE_SCRIPT_URL, { 
                    method: 'POST', 
                    mode: 'no-cors', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(pendingData) 
                });
                
                status.innerText = "‚úÖ –î–∞–Ω—ñ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ (—á–µ—Ä–≥–∞)!"; 
                status.classList.add('text-emerald-600');
                
                setTimeout(() => {
                    closeModal('sendModal');
                    performReset(); 
                }, 1500);
                
            } catch(e) { 
                status.innerText = "‚ùå –ü–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è"; 
                status.classList.add('text-red-500'); 
                actions.style.display = 'flex'; 
                spinner.classList.add('hidden'); 
            }
        }
        
        document.getElementById('confirmSendBtn').onclick = executeSend;
    </script>
</body>
</html>
